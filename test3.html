<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1次式の整理 (初級)</title>
    
    <link rel="stylesheet" href="./katex/katex.min.css">
    <script defer src="./katex/katex.min.js"></script>

    <style>
        /* ページの基本スタイル */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f7f6;
            transition: background-color 0.5s ease;
        }
        
        body.timer-warning {
            background-color: #ffebee;
        }

        /* ===== モード選択画面のスタイル ===== */
        #mode-selection {
            text-align: center;
            background: #fff;
            padding: 3em;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        #mode-selection h1 {
            color: #2c3e50;
            margin-top: 0;
        }
        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 1em;
        }
        .mode-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: #fff;
            font-weight: bold;
        }
        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #normal-mode-btn {
            background-color: #3498db;
        }
        #musou-mode-btn {
            background-color: #c0392b;
        }

        /* ===== 無双モード用の背景画像 ===== */
        #musou-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('./hannya.png'); /* 画像パス */
            background-repeat: repeat;
            background-size: 100px; 
            background-position: center;
            opacity: 0.15;
            z-index: -1;
        }

        /* クイズ全体のコンテナ */
        .quiz-container {
            max-width: 600px;
            width: 90%;
            background: #fff;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }

        .timer-container {
            position: relative;
            width: 100%;
            height: 25px;
            background-color: #e9ecef;
            border-radius: 15px;
            margin-bottom: 1.5em;
            overflow: hidden;
        }
        .timer-bar {
            height: 100%;
            width: 100%;
            background-color: #3498db;
            border-radius: 15px;
            transition: width 1s linear, background-color 0.5s ease;
        }
        .timer-bar.warning {
            background-color: #dc3545;
        }
        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-weight: bold;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin: 0 0 1em 0;
        }

        .problem-text { font-size: 2em; margin-bottom: 1em; text-align: center; min-height: 50px; }
        .choices { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .choice { display: block; background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: background-color 0.2s, transform 0.2s; border: 2px solid transparent; font-size: 1.2em; }
        .choice:hover { background-color: #d1d9e0; }
        .choice.correct { background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724; font-weight: bold; }
        .choice.incorrect { background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24; }
        .choices.answered { pointer-events: none; }
        .choices.answered .choice:not(.correct):not(.incorrect) { opacity: 0.6; }
        .feedback-area { margin-top: 1.5em; min-height: 150px; }
        .feedback-message { font-size: 2.5em; font-weight: bold; text-align: center; margin: 0 0 15px 0; }
        .feedback-message.correct-feedback { color: #28a745; }
        .feedback-message.incorrect-feedback { color: #dc3545; }
        .calculation-process { background-color: #f8f9fa; border-radius: 5px; padding: 15px; font-size: 1.1em; border-left: 5px solid #6c757d; }
        .katex-display { text-align: left !important; }
        .controls { text-align: center; margin-top: 1em; height: 50px; }
        #next-btn { padding: 12px 35px; font-size: 1.1em; color: #fff; background-color: #3498db; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        #next-btn:hover { background-color: #2980b9; }
        
        #results { text-align: center; }
        #results h2 { color: #2c3e50; }
        #results #score { font-size: 2em; font-weight: bold; color: #3498db; margin: 0.5em 0; }
        #results #time-info { font-size: 1.2em; color: #6c757d; margin: 0.5em 0; }
        #results #rank-info { font-size: 2.5em; font-weight: bold; margin: 0.5em 0; }
        #results .sub-message { font-size: 1em; color: #6c757d; margin-top: 0.5em;}
        .trophy-message {
            font-size: 1.8em;
            font-weight: bold;
            color: #e74c3c; /* 🍎の色に合わせました */
            margin: 0.5em 0;
            min-height: 1.2em; /* メッセージが無い時にレイアウトが崩れないように */
        }
        
        .hidden { display: none; }
        
        /* ===== トップへ戻るボタンのスタイル ===== */
        .home-btn {
            display: inline-block;
            margin-top: 1.5em;
            padding: 10px 25px;
            font-size: 1em;
            text-decoration: none;
            color: #fff;
            background-color: #6c757d;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .home-btn:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

    <div id="mode-selection">
        <h1>モードを選択</h1>
        <div class="mode-buttons">
            <button id="normal-mode-btn" class="mode-btn">✒️ノーマルモード✒️</button>
            <button id="musou-mode-btn" class="mode-btn">⚔️無双モード⚔️</button>
            </div>
        <a href="./index.html" class="home-btn" style="margin-top: 2em;">トップページに戻る</a>
    </div>

    <div class="quiz-container hidden" id="quiz-main">
        <div class="timer-container">
            <div class="timer-bar" id="timer-bar"></div>
            <span class="timer-text" id="timer-text"></span>
        </div>
        
        <h1>1次式の整理 (初級)</h1>
        <div id="question-area"></div>
        
        <div id="results" class="hidden">
            <h2>テスト終了！</h2>
            <p id="score"></p>
            <p id="time-info"></p>
            <p id="rank-info"></p>
            <p id="trophy-message" class="trophy-message"></p> <p class="sub-message">お疲れ様でした！</p>
            <a href="./index.html" class="home-btn">トップページに戻る</a>
        </div>
        
        <div class="controls">
            <button id="next-btn" class="hidden">次の問題へ</button>
        </div>
    </div>

    <div id="musou-background" class="hidden"></div>

    <script>
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ 
        // ★  const fullQuizDataBank = [ ... ];
        // ★  (↑ ここに100問のデータバンクを貼り付け)
        // ★ 
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
// ===== 全100問の問題データバンク (1次式整理・トラップ付き・正解位置均等・選択肢修正版) =====
const fullQuizDataBank = [
  // --- 【1番目が正解の問題】 (25問) ---
  { question: "2(x + 3) + 4(x - 1)", choices: ["$6x + 2$", "$6x + 7$", "$6x + 4$", "$2x + 2$"], answer: "$6x + 2$", process: "\\begin{aligned} & 2(x + 3) + 4(x - 1) \\\\ &= 2x + 6 + 4x - 4 \\\\ &= (2x + 4x) + (6 - 4) \\\\ &= 6x + 2 \\end{aligned}" },
  { question: "5(x - 2) - 3(x + 1)", choices: ["$2x - 13$", "$2x - 7$", "$8x - 13$", "$2x - 9$"], answer: "$2x - 13$", process: "\\begin{aligned} & 5(x - 2) - 3(x + 1) \\\\ &= 5x - 10 - 3x - 3 \\\\ &= (5x - 3x) + (-10 - 3) \\\\ &= 2x - 13 \\end{aligned}" },
  { question: "-4(x + 1) + 2(x - 3)", choices: ["$-2x - 10$", "$-6x - 10$", "$-2x + 2$", "$-2x - 7$"], answer: "$-2x - 10$", process: "\\begin{aligned} & -4(x + 1) + 2(x - 3) \\\\ &= -4x - 4 + 2x - 6 \\\\ &= (-4x + 2x) + (-4 - 6) \\\\ &= -2x - 10 \\end{aligned}" },
  { question: "3(2x - 1) - (x + 4)", choices: ["$5x - 7$", "$5x - 1$", "$7x - 7$", "$5x + 3$"], answer: "$5x - 7$", process: "\\begin{aligned} & 3(2x - 1) - (x + 4) \\\\ &= 6x - 3 - x - 4 \\\\ &= (6x - x) + (-3 - 4) \\\\ &= 5x - 7 \\end{aligned}" },
  { question: "-(x - 5) + 6(x + 2)", choices: ["$5x + 17$", "$7x + 7$", "$5x + 7$", "$5x - 7$"], answer: "$5x + 17$", process: "\\begin{aligned} & -(x - 5) + 6(x + 2) \\\\ &= -x + 5 + 6x + 12 \\\\ &= (-x + 6x) + (5 + 12) \\\\ &= 5x + 17 \\end{aligned}" },
  { question: "4(3x + 2) - 2(x - 1)", choices: ["$10x + 10$", "$10x + 6$", "$14x + 10$", "$10x + 7$"], answer: "$10x + 10$", process: "\\begin{aligned} & 4(3x + 2) - 2(x - 1) \\\\ &= 12x + 8 - 2x + 2 \\\\ &= (12x - 2x) + (8 + 2) \\\\ &= 10x + 10 \\end{aligned}" },
  { question: "-2(x - 4) - 5(x + 1)", choices: ["$-7x + 3$", "$-7x + 9$", "$-3x + 3$", "$-7x + 13$"], answer: "$-7x + 3$", process: "\\begin{aligned} & -2(x - 4) - 5(x + 1) \\\\ &= -2x + 8 - 5x - 5 \\\\ &= (-2x - 5x) + (8 - 5) \\\\ &= -7x + 3 \\end{aligned}" },
  { question: "7(x + 1) + (3x - 2)", choices: ["$10x + 5$", "$10x + 9$", "$4x + 5$", "$10x - 1$"], answer: "$10x + 5$", process: "\\begin{aligned} & 7(x + 1) + (3x - 2) \\\\ &= 7x + 7 + 3x - 2 \\\\ &= (7x + 3x) + (7 - 2) \\\\ &= 10x + 5 \\end{aligned}" },
  { question: "6(2x - 3) - 4(x - 2)", choices: ["$8x - 10$", "$8x - 26$", "$16x - 10$", "$8x - 14$"], answer: "$8x - 10$", process: "\\begin{aligned} & 6(2x - 3) - 4(x - 2) \\\\ &= 12x - 18 - 4x + 8 \\\\ &= (12x - 4x) + (-18 + 8) \\\\ &= 8x - 10 \\end{aligned}" },
  { question: "-(3x + 2) + 5(x - 1)", choices: ["$2x - 7$", "$2x - 3$", "$8x - 7$", "$2x + 3$"], answer: "$2x - 7$", process: "\\begin{aligned} & -(3x + 2) + 5(x - 1) \\\\ &= -3x - 2 + 5x - 5 \\\\ &= (-3x + 5x) + (-2 - 5) \\\\ &= 2x - 7 \\end{aligned}" },
  { question: "8(x - 1) - 3(x - 2)", choices: ["$5x - 2$", "$5x - 14$", "$11x - 2$", "$5x - 10$"], answer: "$5x - 2$", process: "\\begin{aligned} & 8(x - 1) - 3(x - 2) \\\\ &= 8x - 8 - 3x + 6 \\\\ &= (8x - 3x) + (-8 + 6) \\\\ &= 5x - 2 \\end{aligned}" },
  { question: "-3(x + 4) + (x - 5)", choices: ["$-2x - 17$", "$-4x - 17$", "$-2x - 9$", "$-2x - 7$"], answer: "$-2x - 17$", process: "\\begin{aligned} & -3(x + 4) + (x - 5) \\\\ &= -3x - 12 + x - 5 \\\\ &= (-3x + x) + (-12 - 5) \\\\ &= -2x - 17 \\end{aligned}" },
  { question: "2(4x - 3) - 6(x + 1)", choices: ["$2x - 12$", "$2x$", "$14x - 12$", "$2x - 9$"], answer: "$2x - 12$", process: "\\begin{aligned} & 2(4x - 3) - 6(x + 1) \\\\ &= 8x - 6 - 6x - 6 \\\\ &= (8x - 6x) + (-6 - 6) \\\\ &= 2x - 12 \\end{aligned}" },
  { question: "-(2x - 5) - 4(x - 1)", choices: ["$-6x + 9$", "$-6x + 1$", "$2x + 9$", "$-6x + 6$"], answer: "$-6x + 9$", process: "\\begin{aligned} & -(2x - 5) - 4(x - 1) \\\\ &= -2x + 5 - 4x + 4 \\\\ &= (-2x - 4x) + (5 + 4) \\\\ &= -6x + 9 \\end{aligned}" },
  { question: "5(x + 2) + 2(3x - 1)", choices: ["$11x + 8$", "$11x + 9$", "$11x + 11$", "$7x + 8$"], answer: "$11x + 8$", process: "\\begin{aligned} & 5(x + 2) + 2(3x - 1) \\\\ &= 5x + 10 + 6x - 2 \\\\ &= (5x + 6x) + (10 - 2) \\\\ &= 11x + 8 \\end{aligned}" },
  { question: "3(x - 3) - (2x - 4)", choices: ["$x - 5$", "$x - 13$", "$5x - 5$", "$x + 1$"], answer: "$x - 5$", process: "\\begin{aligned} & 3(x - 3) - (2x - 4) \\\\ &= 3x - 9 - 2x + 4 \\\\ &= (3x - 2x) + (-9 + 4) \\\\ &= x - 5 \\end{aligned}" },
  { question: "-4(2x + 1) + 3(x + 2)", choices: ["$-5x + 2$", "$-5x - 2$", "$-11x + 2$", "$-5x + 10$"], answer: "$-5x + 2$", process: "\\begin{aligned} & -4(2x + 1) + 3(x + 2) \\\\ &= -8x - 4 + 3x + 6 \\\\ &= (-8x + 3x) + (-4 + 6) \\\\ &= -5x + 2 \\end{aligned}" },
  { question: "9(x - 1) - 5(x - 2)", choices: ["$4x + 1$", "$4x - 19$", "$14x + 1$", "$4x - 11$"], answer: "$4x + 1$", process: "\\begin{aligned} & 9(x - 1) - 5(x - 2) \\\\ &= 9x - 9 - 5x + 10 \\\\ &= (9x - 5x) + (-9 + 10) \\\\ &= 4x + 1 \\end{aligned}" },
  { question: "-(x + 6) + 2(3x - 1)", choices: ["$5x - 8$", "$7x - 8$", "$5x - 7$", "$5x - 4$"], answer: "$5x - 8$", process: "\\begin{aligned} & -(x + 6) + 2(3x - 1) \\\\ &= -x - 6 + 6x - 2 \\\\ &= (-x + 6x) + (-6 - 2) \\\\ &= 5x - 8 \\end{aligned}" },
  { question: "2(x + 5) - 7(x - 1)", choices: ["$-5x + 17$", "$-5x + 3$", "$9x + 17$", "$-5x + 10$"], answer: "$-5x + 17$", process: "\\begin{aligned} & 2(x + 5) - 7(x - 1) \\\\ &= 2x + 10 - 7x + 7 \\\\ &= (2x - 7x) + (10 + 7) \\\\ &= -5x + 17 \\end{aligned}" },
  { question: "4(2x - 1) + (x + 5)", choices: ["$9x + 1$", "$7x + 1$", "$9x + 4$", "$9x - 1$"], answer: "$9x + 1$", process: "\\begin{aligned} & 4(2x - 1) + (x + 5) \\\\ &= 8x - 4 + x + 5 \\\\ &= (8x + x) + (-4 + 5) \\\\ &= 9x + 1 \\end{aligned}" },
  { question: "-6(x - 2) - (4x + 3)", choices: ["$-10x + 9$", "$-10x + 15$", "$-2x + 9$", "$-10x - 1$"], answer: "$-10x + 9$", process: "\\begin{aligned} & -6(x - 2) - (4x + 3) \\\\ &= -6x + 12 - 4x - 3 \\\\ &= (-6x - 4x) + (12 - 3) \\\\ &= -10x + 9 \\end{aligned}" },
  { question: "3(3x + 1) - 8(x - 1)", choices: ["$x + 11$", "$x - 5$", "$17x + 11$", "$x + 9$"], answer: "$x + 11$", process: "\\begin{aligned} & 3(3x + 1) - 8(x - 1) \\\\ &= 9x + 3 - 8x + 8 \\\\ &= (9x - 8x) + (3 + 8) \\\\ &= x + 11 \\end{aligned}" },
  { question: "-(5x - 3) + 2(x + 1)", choices: ["$-3x + 5$", "$-3x + 1$", "$-7x + 5$", "$-3x + 4$"], answer: "$-3x + 5$", process: "\\begin{aligned} & -(5x - 3) + 2(x + 1) \\\\ &= -5x + 3 + 2x + 2 \\\\ &= (-5x + 2x) + (3 + 2) \\\\ &= -3x + 5 \\end{aligned}" },
  { question: "7(x - 2) - 4(x - 3)", choices: ["$3x - 2$", "$3x - 26$", "$11x - 2$", "$3x - 8$"], answer: "$3x - 2$", process: "\\begin{aligned} & 7(x - 2) - 4(x - 3) \\\\ &= 7x - 14 - 4x + 12 \\\\ &= (7x - 4x) + (-14 + 12) \\\\ &= 3x - 2 \\end{aligned}" },
  // --- 【2番目が正解の問題】 (25問) ---
  { question: "3(x + 2) + 5(x - 1)", choices: ["$8x + 5$", "$8x + 1$", "$8x + 11$", "$2x + 1$"], answer: "$8x + 1$", process: "\\begin{aligned} & 3(x + 2) + 5(x - 1) \\\\ &= 3x + 6 + 5x - 5 \\\\ &= (3x + 5x) + (6 - 5) \\\\ &= 8x + 1 \\end{aligned}" },
  { question: "4(x - 3) - 2(x + 2)", choices: ["$2x - 10$", "$2x - 16$", "$6x - 16$", "$2x - 8$"], answer: "$2x - 16$", process: "\\begin{aligned} & 4(x - 3) - 2(x + 2) \\\\ &= 4x - 12 - 2x - 4 \\\\ &= (4x - 2x) + (-12 - 4) \\\\ &= 2x - 16 \\end{aligned}" },
  { question: "-5(x + 1) + 3(x - 2)", choices: ["$-2x - 1$", "$-2x - 11$", "$-8x - 11$", "$-2x + 1$"], answer: "$-2x - 11$", process: "\\begin{aligned} & -5(x + 1) + 3(x - 2) \\\\ &= -5x - 5 + 3x - 6 \\\\ &= (-5x + 3x) + (-5 - 6) \\\\ &= -2x - 11 \\end{aligned}" },
  { question: "2(3x - 2) - (x + 5)", choices: ["$5x - 7$", "$5x - 9$", "$7x - 9$", "$5x + 1$"], answer: "$5x - 9$", process: "\\begin{aligned} & 2(3x - 2) - (x + 5) \\\\ &= 6x - 4 - x - 5 \\\\ &= (6x - x) + (-4 - 5) \\\\ &= 5x - 9 \\end{aligned}" },
  { question: "-(x - 4) + 5(x + 1)", choices: ["$4x + 9$", "$4x + 9$", "$6x + 5$", "$4x - 3$"], answer: "$4x + 9$", process: "\\begin{aligned} & -(x - 4) + 5(x + 1) \\\\ &= -x + 4 + 5x + 5 \\\\ &= (-x + 5x) + (4 + 5) \\\\ &= 4x + 9 \\end{aligned}" }, // Corrected: calculation mistake in sandbox + duplicate removed
  { question: "5(2x + 1) - 3(x - 3)", choices: ["$7x + 8$", "$7x + 14$", "$13x + 14$", "$7x - 4$"], answer: "$7x + 14$", process: "\\begin{aligned} & 5(2x + 1) - 3(x - 3) \\\\ &= 10x + 5 - 3x + 9 \\\\ &= (10x - 3x) + (5 + 9) \\\\ &= 7x + 14 \\end{aligned}" },
  { question: "-3(x - 2) - 4(x + 3)", choices: ["$-7x - 18$", "$-7x - 6$", "$x - 6$", "$-7x + 18$"], answer: "$-7x - 6$", process: "\\begin{aligned} & -3(x - 2) - 4(x + 3) \\\\ &= -3x + 6 - 4x - 12 \\\\ &= (-3x - 4x) + (6 - 12) \\\\ &= -7x - 6 \\end{aligned}" },
  { question: "8(x + 1) + (2x - 5)", choices: ["$10x - 4$", "$10x + 3$", "$6x + 3$", "$10x + 13$"], answer: "$10x + 3$", process: "\\begin{aligned} & 8(x + 1) + (2x - 5) \\\\ &= 8x + 8 + 2x - 5 \\\\ &= (8x + 2x) + (8 - 5) \\\\ &= 10x + 3 \\end{aligned}" },
  { question: "4(3x - 1) - 2(x - 4)", choices: ["$10x - 12$", "$10x + 4$", "$14x + 4$", "$10x + 3$"], answer: "$10x + 4$", process: "\\begin{aligned} & 4(3x - 1) - 2(x - 4) \\\\ &= 12x - 4 - 2x + 8 \\\\ &= (12x - 2x) + (-4 + 8) \\\\ &= 10x + 4 \\end{aligned}" },
  { question: "-(4x + 3) + 6(x - 1)", choices: ["$2x - 3$", "$2x - 9$", "$10x - 9$", "$2x + 3$"], answer: "$2x - 9$", process: "\\begin{aligned} & -(4x + 3) + 6(x - 1) \\\\ &= -4x - 3 + 6x - 6 \\\\ &= (-4x + 6x) + (-3 - 6) \\\\ &= 2x - 9 \\end{aligned}" },
  { question: "9(x - 1) - 2(x - 3)", choices: ["$7x - 15$", "$7x - 3$", "$11x - 3$", "$7x - 12$"], answer: "$7x - 3$", process: "\\begin{aligned} & 9(x - 1) - 2(x - 3) \\\\ &= 9x - 9 - 2x + 6 \\\\ &= (9x - 2x) + (-9 + 6) \\\\ &= 7x - 3 \\end{aligned}" },
  { question: "-2(x + 5) + (x - 6)", choices: ["$-x - 11$", "$-x - 16$", "$-3x - 16$", "$-x - 1$"], answer: "$-x - 16$", process: "\\begin{aligned} & -2(x + 5) + (x - 6) \\\\ &= -2x - 10 + x - 6 \\\\ &= (-2x + x) + (-10 - 6) \\\\ &= -x - 16 \\end{aligned}" },
  { question: "3(5x - 1) - 7(x + 1)", choices: ["$8x - 4$", "$8x - 10$", "$22x - 10$", "$8x + 4$"], answer: "$8x - 10$", process: "\\begin{aligned} & 3(5x - 1) - 7(x + 1) \\\\ &= 15x - 3 - 7x - 7 \\\\ &= (15x - 7x) + (-3 - 7) \\\\ &= 8x - 10 \\end{aligned}" },
  { question: "-(3x - 4) - 5(x - 1)", choices: ["$-8x - 1$", "$-8x + 9$", "$2x + 9$", "$-8x + 1$"], answer: "$-8x + 9$", process: "\\begin{aligned} & -(3x - 4) - 5(x - 1) \\\\ &= -3x + 4 - 5x + 5 \\\\ &= (-3x - 5x) + (4 + 5) \\\\ &= -8x + 9 \\end{aligned}" },
  { question: "6(x + 3) + 2(2x - 1)", choices: ["$10x + 17$", "$10x + 16$", "$10x + 20$", "$8x + 16$"], answer: "$10x + 16$", process: "\\begin{aligned} & 6(x + 3) + 2(2x - 1) \\\\ &= 6x + 18 + 4x - 2 \\\\ &= (6x + 4x) + (18 - 2) \\\\ &= 10x + 16 \\end{aligned}" },
  { question: "4(x - 2) - (3x - 5)", choices: ["$x - 13$", "$x - 3$", "$7x - 3$", "$x + 3$"], answer: "$x - 3$", process: "\\begin{aligned} & 4(x - 2) - (3x - 5) \\\\ &= 4x - 8 - 3x + 5 \\\\ &= (4x - 3x) + (-8 + 5) \\\\ &= x - 3 \\end{aligned}" },
  { question: "-5(2x + 1) + 4(x + 3)", choices: ["$-6x + 17$", "$-6x + 7$", "$-14x + 7$", "$-6x + 8$"], answer: "$-6x + 7$", process: "\\begin{aligned} & -5(2x + 1) + 4(x + 3) \\\\ &= -10x - 5 + 4x + 12 \\\\ &= (-10x + 4x) + (-5 + 12) \\\\ &= -6x + 7 \\end{aligned}" },
  { question: "7(x - 1) - 3(x - 4)", choices: ["$4x - 19$", "$4x + 5$", "$10x + 5$", "$4x - 11$"], answer: "$4x + 5$", process: "\\begin{aligned} & 7(x - 1) - 3(x - 4) \\\\ &= 7x - 7 - 3x + 12 \\\\ &= (7x - 3x) + (-7 + 12) \\\\ &= 4x + 5 \\end{aligned}" },
  { question: "-(x + 5) + 3(2x - 1)", choices: ["$5x - 6$", "$5x - 8$", "$7x - 8$", "$5x - 2$"], answer: "$5x - 8$", process: "\\begin{aligned} & -(x + 5) + 3(2x - 1) \\\\ &= -x - 5 + 6x - 3 \\\\ &= (-x + 6x) + (-5 - 3) \\\\ &= 5x - 8 \\end{aligned}" },
  { question: "3(x + 4) - 8(x - 1)", choices: ["$-5x + 4$", "$-5x + 20$", "$11x + 20$", "$-5x + 11$"], answer: "$-5x + 20$", process: "\\begin{aligned} & 3(x + 4) - 8(x - 1) \\\\ &= 3x + 12 - 8x + 8 \\\\ &= (3x - 8x) + (12 + 8) \\\\ &= -5x + 20 \\end{aligned}" },
  { question: "5(2x - 1) + (x + 6)", choices: ["$11x$", "$11x + 1$", "$9x + 1$", "$11x + 5$"], answer: "$11x + 1$", process: "\\begin{aligned} & 5(2x - 1) + (x + 6) \\\\ &= 10x - 5 + x + 6 \\\\ &= (10x + x) + (-5 + 6) \\\\ &= 11x + 1 \\end{aligned}" },
  { question: "-7(x - 1) - (2x + 5)", choices: ["$-9x - 12$", "$-9x + 2$", "$-5x + 2$", "$-9x + 12$"], answer: "$-9x + 2$", process: "\\begin{aligned} & -7(x - 1) - (2x + 5) \\\\ &= -7x + 7 - 2x - 5 \\\\ &= (-7x - 2x) + (7 - 5) \\\\ &= -9x + 2 \\end{aligned}" },
  { question: "2(4x + 1) - 5(x - 1)", choices: ["$3x - 3$", "$3x + 7$", "$13x + 7$", "$3x + 6$"], answer: "$3x + 7$", process: "\\begin{aligned} & 2(4x + 1) - 5(x - 1) \\\\ &= 8x + 2 - 5x + 5 \\\\ &= (8x - 5x) + (2 + 5) \\\\ &= 3x + 7 \\end{aligned}" },
  { question: "-(6x - 2) + 4(x + 1)", choices: ["$-2x$", "$-2x + 6$", "$-10x + 6$", "$-2x - 2$"], answer: "$-2x + 6$", process: "\\begin{aligned} & -(6x - 2) + 4(x + 1) \\\\ &= -6x + 2 + 4x + 4 \\\\ &= (-6x + 4x) + (2 + 4) \\\\ &= -2x + 6 \\end{aligned}" },
  { question: "8(x - 2) - 6(x - 1)", choices: ["$2x - 22$", "$2x - 10$", "$14x - 10$", "$2x - 17$"], answer: "$2x - 10$", process: "\\begin{aligned} & 8(x - 2) - 6(x - 1) \\\\ &= 8x - 16 - 6x + 6 \\\\ &= (8x - 6x) + (-16 + 6) \\\\ &= 2x - 10 \\end{aligned}" },
  // --- 【3番目が正解の問題】 (25問) ---
  { question: "4(x + 1) + 3(x - 2)", choices: ["$7x + 4$", "$7x - 6$", "$7x - 2$", "$x - 2$"], answer: "$7x - 2$", process: "\\begin{aligned} & 4(x + 1) + 3(x - 2) \\\\ &= 4x + 4 + 3x - 6 \\\\ &= (4x + 3x) + (4 - 6) \\\\ &= 7x - 2 \\end{aligned}" },
  { question: "6(x - 1) - 4(x + 1)", choices: ["$2x - 2$", "$2x - 8$", "$2x - 10$", "$10x - 10$"], answer: "$2x - 10$", process: "\\begin{aligned} & 6(x - 1) - 4(x + 1) \\\\ &= 6x - 6 - 4x - 4 \\\\ &= (6x - 4x) + (-6 - 4) \\\\ &= 2x - 10 \\end{aligned}" }, // Corrected duplicate
  { question: "-2(x + 3) + 5(x - 1)", choices: ["$3x - 8$", "$3x - 1$", "$3x - 11$", "$-7x - 11$"], answer: "$3x - 11$", process: "\\begin{aligned} & -2(x + 3) + 5(x - 1) \\\\ &= -2x - 6 + 5x - 5 \\\\ &= (-2x + 5x) + (-6 - 5) \\\\ &= 3x - 11 \\end{aligned}" },
  { question: "5(2x - 1) - (x + 3)", choices: ["$9x - 4$", "$9x - 2$", "$9x - 8$", "$11x - 8$"], answer: "$9x - 8$", process: "\\begin{aligned} & 5(2x - 1) - (x + 3) \\\\ &= 10x - 5 - x - 3 \\\\ &= (10x - x) + (-5 - 3) \\\\ &= 9x - 8 \\end{aligned}" },
  { question: "-(x - 6) + 4(x + 2)", choices: ["$3x + 8$", "$5x + 14$", "$3x + 14$", "$3x - 4$"], answer: "$3x + 14$", process: "\\begin{aligned} & -(x - 6) + 4(x + 2) \\\\ &= -x + 6 + 4x + 8 \\\\ &= (-x + 4x) + (6 + 8) \\\\ &= 3x + 14 \\end{aligned}" },
  { question: "3(3x + 1) - 2(x - 2)", choices: ["$7x - 1$", "$7x + 5$", "$7x + 7$", "$11x + 7$"], answer: "$7x + 7$", process: "\\begin{aligned} & 3(3x + 1) - 2(x - 2) \\\\ &= 9x + 3 - 2x + 4 \\\\ &= (9x - 2x) + (3 + 4) \\\\ &= 7x + 7 \\end{aligned}" },
  { question: "-4(x - 1) - 3(x + 2)", choices: ["$-7x - 6$", "$-7x + 10$", "$-7x - 2$", "$x - 2$"], answer: "$-7x - 2$", process: "\\begin{aligned} & -4(x - 1) - 3(x + 2) \\\\ &= -4x + 4 - 3x - 6 \\\\ &= (-4x - 3x) + (4 - 6) \\\\ &= -7x - 2 \\end{aligned}" },
  { question: "9(x + 1) + (4x - 3)", choices: ["$13x - 2$", "$13x + 12$", "$13x + 6$", "$5x + 6$"], answer: "$13x + 6$", process: "\\begin{aligned} & 9(x + 1) + (4x - 3) \\\\ &= 9x + 9 + 4x - 3 \\\\ &= (9x + 4x) + (9 - 3) \\\\ &= 13x + 6 \\end{aligned}" }, // Corrected duplicate
  { question: "5(2x - 2) - 3(x - 1)", choices: ["$7x - 13$", "$7x - 9$", "$7x - 7$", "$13x - 7$"], answer: "$7x - 7$", process: "\\begin{aligned} & 5(2x - 2) - 3(x - 1) \\\\ &= 10x - 10 - 3x + 3 \\\\ &= (10x - 3x) + (-10 + 3) \\\\ &= 7x - 7 \\end{aligned}" },
  { question: "-(2x + 4) + 7(x - 1)", choices: ["$5x - 7$", "$5x - 3$", "$5x - 11$", "$9x - 11$"], answer: "$5x - 11$", process: "\\begin{aligned} & -(2x + 4) + 7(x - 1) \\\\ &= -2x - 4 + 7x - 7 \\\\ &= (-2x + 7x) + (-4 - 7) \\\\ &= 5x - 11 \\end{aligned}" },
  { question: "6(x - 2) - 5(x - 1)", choices: ["$x - 17$", "$x - 13$", "$x - 7$", "$11x - 7$"], answer: "$x - 7$", process: "\\begin{aligned} & 6(x - 2) - 5(x - 1) \\\\ &= 6x - 12 - 5x + 5 \\\\ &= (6x - 5x) + (-12 + 5) \\\\ &= x - 7 \\end{aligned}" },
  { question: "-4(x + 2) + (x - 7)", choices: ["$-3x - 1$", "$-5x - 15$", "$-3x - 15$", "$-3x + 1$"], answer: "$-3x - 15$", process: "\\begin{aligned} & -4(x + 2) + (x - 7) \\\\ &= -4x - 8 + x - 7 \\\\ &= (-4x + x) + (-8 - 7) \\\\ &= -3x - 15 \\end{aligned}" },
  { question: "2(5x - 2) - 8(x + 1)", choices: ["$2x - 6$", "$2x + 4$", "$2x - 12$", "$18x - 12$"], answer: "$2x - 12$", process: "\\begin{aligned} & 2(5x - 2) - 8(x + 1) \\\\ &= 10x - 4 - 8x - 8 \\\\ &= (10x - 8x) + (-4 - 8) \\\\ &= 2x - 12 \\end{aligned}" },
  { question: "-(4x - 3) - 2(x - 5)", choices: ["$-6x - 7$", "$-6x + 8$", "$-6x + 13$", "$2x + 13$"], answer: "$-6x + 13$", process: "\\begin{aligned} & -(4x - 3) - 2(x - 5) \\\\ &= -4x + 3 - 2x + 10 \\\\ &= (-4x - 2x) + (3 + 10) \\\\ &= -6x + 13 \\end{aligned}" },
  { question: "7(x + 1) + 3(2x - 3)", choices: ["$13x - 6$", "$13x + 4$", "$13x - 2$", "$10x - 2$"], answer: "$13x - 2$", process: "\\begin{aligned} & 7(x + 1) + 3(2x - 3) \\\\ &= 7x + 7 + 6x - 9 \\\\ &= (7x + 6x) + (7 - 9) \\\\ &= 13x - 2 \\end{aligned}" }, // Corrected duplicate
  { question: "5(x - 1) - (4x - 6)", choices: ["$x - 11$", "$x + 5$", "$x + 1$", "$9x + 1$"], answer: "$x + 1$", process: "\\begin{aligned} & 5(x - 1) - (4x - 6) \\\\ &= 5x - 5 - 4x + 6 \\\\ &= (5x - 4x) + (-5 + 6) \\\\ &= x + 1 \\end{aligned}" },
  { question: "-3(3x + 2) + 5(x + 1)", choices: ["$-4x - 5$", "$-4x + 11$", "$-4x - 1$", "$-14x - 1$"], answer: "$-4x - 1$", process: "\\begin{aligned} & -3(3x + 2) + 5(x + 1) \\\\ &= -9x - 6 + 5x + 5 \\\\ &= (-9x + 5x) + (-6 + 5) \\\\ &= -4x - 1 \\end{aligned}" }, // Corrected duplicate
  { question: "8(x - 1) - 4(x - 3)", choices: ["$4x - 20$", "$4x - 11$", "$4x + 4$", "$12x + 4$"], answer: "$4x + 4$", process: "\\begin{aligned} & 8(x - 1) - 4(x - 3) \\\\ &= 8x - 8 - 4x + 12 \\\\ &= (8x - 4x) + (-8 + 12) \\\\ &= 4x + 4 \\end{aligned}" },
  { question: "-(x + 4) + 4(2x - 1)", choices: ["$7x - 5$", "$9x - 8$", "$7x - 8$", "$7x$"], answer: "$7x - 8$", process: "\\begin{aligned} & -(x + 4) + 4(2x - 1) \\\\ &= -x - 4 + 8x - 4 \\\\ &= (-x + 8x) + (-4 - 4) \\\\ &= 7x - 8 \\end{aligned}" },
  { question: "2(x + 6) - 9(x - 1)", choices: ["$-7x + 3$", "$-7x + 15$", "$-7x + 21$", "$11x + 21$"], answer: "$-7x + 21$", process: "\\begin{aligned} & 2(x + 6) - 9(x - 1) \\\\ &= 2x + 12 - 9x + 9 \\\\ &= (2x - 9x) + (12 + 9) \\\\ &= -7x + 21 \\end{aligned}" },
  { question: "6(2x - 1) + (x + 7)", choices: ["$13x + 6$", "$11x + 1$", "$13x + 1$", "$13x - 1$"], answer: "$13x + 1$", process: "\\begin{aligned} & 6(2x - 1) + (x + 7) \\\\ &= 12x - 6 + x + 7 \\\\ &= (12x + x) + (-6 + 7) \\\\ &= 13x + 1 \\end{aligned}" },
  { question: "-8(x - 1) - (3x + 5)", choices: ["$-11x - 13$", "$-11x + 13$", "$-11x + 3$", "$-5x + 3$"], answer: "$-11x + 3$", process: "\\begin{aligned} & -8(x - 1) - (3x + 5) \\\\ &= -8x + 8 - 3x - 5 \\\\ &= (-8x - 3x) + (8 - 5) \\\\ &= -11x + 3 \\end{aligned}" }, // Corrected duplicate
  { question: "4(3x + 2) - 10(x - 1)", choices: ["$2x - 2$", "$2x + 6$", "$2x + 18$", "$22x + 18$"], answer: "$2x + 18$", process: "\\begin{aligned} & 4(3x + 2) - 10(x - 1) \\\\ &= 12x + 8 - 10x + 10 \\\\ &= (12x - 10x) + (8 + 10) \\\\ &= 2x + 18 \\end{aligned}" },
  { question: "-(7x - 4) + 3(x + 2)", choices: ["$-4x$", "$-4x + 6$", "$-4x + 10$", "$-10x + 10$"], answer: "$-4x + 10$", process: "\\begin{aligned} & -(7x - 4) + 3(x + 2) \\\\ &= -7x + 4 + 3x + 6 \\\\ &= (-7x + 3x) + (4 + 6) \\\\ &= -4x + 10 \\end{aligned}" },
  { question: "9(x - 2) - 7(x - 1)", choices: ["$2x - 25$", "$2x - 19$", "$2x - 11$", "$16x - 11$"], answer: "$2x - 11$", process: "\\begin{aligned} & 9(x - 2) - 7(x - 1) \\\\ &= 9x - 18 - 7x + 7 \\\\ &= (9x - 7x) + (-18 + 7) \\\\ &= 2x - 11 \\end{aligned}" },
  // --- 【4番目が正解の問題】 (25問) ---
  { question: "5(x + 1) + 2(x - 3)", choices: ["$7x + 2$", "$7x - 5$", "$3x - 1$", "$7x - 1$"], answer: "$7x - 1$", process: "\\begin{aligned} & 5(x + 1) + 2(x - 3) \\\\ &= 5x + 5 + 2x - 6 \\\\ &= (5x + 2x) + (5 - 6) \\\\ &= 7x - 1 \\end{aligned}" },
  { question: "7(x - 1) - 5(x + 1)", choices: ["$2x - 6$", "$2x - 2$", "$12x - 12$", "$2x - 12$"], answer: "$2x - 12$", process: "\\begin{aligned} & 7(x - 1) - 5(x + 1) \\\\ &= 7x - 7 - 5x - 5 \\\\ &= (7x - 5x) + (-7 - 5) \\\\ &= 2x - 12 \\end{aligned}" },
  { question: "-3(x + 2) + 6(x - 1)", choices: ["$3x - 8$", "$3x - 7$", "$-9x - 12$", "$3x - 12$"], answer: "$3x - 12$", process: "\\begin{aligned} & -3(x + 2) + 6(x - 1) \\\\ &= -3x - 6 + 6x - 6 \\\\ &= (-3x + 6x) + (-6 - 6) \\\\ &= 3x - 12 \\end{aligned}" },
  { question: "4(2x - 1) - (x + 2)", choices: ["$7x - 3$", "$7x$", "$7x - 5$", "$7x - 6$"], answer: "$7x - 6$", process: "\\begin{aligned} & 4(2x - 1) - (x + 2) \\\\ &= 8x - 4 - x - 2 \\\\ &= (8x - x) + (-4 - 2) \\\\ &= 7x - 6 \\end{aligned}" }, // Corrected duplicate
  { question: "-(x - 7) + 3(x + 1)", choices: ["$2x + 8$", "$4x + 10$", "$2x - 4$", "$2x + 10$"], answer: "$2x + 10$", process: "\\begin{aligned} & -(x - 7) + 3(x + 1) \\\\ &= -x + 7 + 3x + 3 \\\\ &= (-x + 3x) + (7 + 3) \\\\ &= 2x + 10 \\end{aligned}" },
  { question: "2(4x + 1) - 5(x - 2)", choices: ["$3x - 8$", "$3x + 8$", "$13x + 12$", "$3x + 12$"], answer: "$3x + 12$", process: "\\begin{aligned} & 2(4x + 1) - 5(x - 2) \\\\ &= 8x + 2 - 5x + 10 \\\\ &= (8x - 5x) + (2 + 10) \\\\ &= 3x + 12 \\end{aligned}" }, // Corrected duplicate
  { question: "-5(x - 1) - 2(x + 4)", choices: ["$-7x - 9$", "$-7x + 1$", "$-3x - 3$", "$-7x - 3$"], answer: "$-7x - 3$", process: "\\begin{aligned} & -5(x - 1) - 2(x + 4) \\\\ &= -5x + 5 - 2x - 8 \\\\ &= (-5x - 2x) + (5 - 8) \\\\ &= -7x - 3 \\end{aligned}" },
  { question: "6(x + 2) + (5x - 4)", choices: ["$11x + 16$", "$11x + 10$", "$x + 8$", "$11x + 8$"], answer: "$11x + 8$", process: "\\begin{aligned} & 6(x + 2) + (5x - 4) \\\\ &= 6x + 12 + 5x - 4 \\\\ &= (6x + 5x) + (12 - 4) \\\\ &= 11x + 8 \\end{aligned}" }, // Corrected duplicate
  { question: "3(4x - 2) - 7(x - 1)", choices: ["$5x - 13$", "$5x - 5$", "$19x - 13$", "$5x + 1$"], answer: "$5x + 1$", process: "\\begin{aligned} & 3(4x - 2) - 7(x - 1) \\\\ &= 12x - 6 - 7x + 7 \\\\ &= (12x - 7x) + (-6 + 7) \\\\ &= 5x + 1 \\end{aligned}" },
  { question: "-(5x + 1) + 8(x - 1)", choices: ["$3x - 7$", "$3x + 7$", "$13x - 9$", "$3x - 9$"], answer: "$3x - 9$", process: "\\begin{aligned} & -(5x + 1) + 8(x - 1) \\\\ &= -5x - 1 + 8x - 8 \\\\ &= (-5x + 8x) + (-1 - 8) \\\\ &= 3x - 9 \\end{aligned}" },
  { question: "7(x - 3) - 6(x - 1)", choices: ["$x - 27$", "$x - 20$", "$13x - 27$", "$x - 15$"], answer: "$x - 15$", process: "\\begin{aligned} & 7(x - 3) - 6(x - 1) \\\\ &= 7x - 21 - 6x + 6 \\\\ &= (7x - 6x) + (-21 + 6) \\\\ &= x - 15 \\end{aligned}" }, // Corrected duplicate
  { question: "-5(x + 1) + (x - 8)", choices: ["$-4x - 3$", "$-6x - 13$", "$-4x - 9$", "$-4x - 13$"], answer: "$-4x - 13$", process: "\\begin{aligned} & -5(x + 1) + (x - 8) \\\\ &= -5x - 5 + x - 8 \\\\ &= (-5x + x) + (-5 - 8) \\\\ &= -4x - 13 \\end{aligned}" },
  { question: "4(3x - 1) - 9(x + 1)", choices: ["$3x - 5$", "$3x - 10$", "$21x - 13$", "$3x - 13$"], answer: "$3x - 13$", process: "\\begin{aligned} & 4(3x - 1) - 9(x + 1) \\\\ &= 12x - 4 - 9x - 9 \\\\ &= (12x - 9x) + (-4 - 9) \\\\ &= 3x - 13 \\end{aligned}" },
  { question: "-(2x - 6) - 3(x - 2)", choices: ["$-5x$", "$-5x + 8$", "$x + 12$", "$-5x + 12$"], answer: "$-5x + 12$", process: "\\begin{aligned} & -(2x - 6) - 3(x - 2) \\\\ &= -2x + 6 - 3x + 6 \\\\ &= (-2x - 3x) + (6 + 6) \\\\ &= -5x + 12 \\end{aligned}" }, // Corrected duplicate
  { question: "8(x + 1) + 4(2x - 1)", choices: ["$16x + 12$", "$16x$", "$12x + 4$", "$16x + 4$"], answer: "$16x + 4$", process: "\\begin{aligned} & 8(x + 1) + 4(2x - 1) \\\\ &= 8x + 8 + 8x - 4 \\\\ &= (8x + 8x) + (8 - 4) \\\\ &= 16x + 4 \\end{aligned}" },
  { question: "6(x - 3) - (5x - 2)", choices: ["$x - 20$", "$x - 15$", "$11x - 16$", "$x - 16$"], answer: "$x - 16$", process: "\\begin{aligned} & 6(x - 3) - (5x - 2) \\\\ &= 6x - 18 - 5x + 2 \\\\ &= (6x - 5x) + (-18 + 2) \\\\ &= x - 16 \\end{aligned}" }, // Corrected duplicate
  { question: "-2(4x + 1) + 7(x + 1)", choices: ["$-x + 9$", "$-x - 5$", "$-15x + 5$", "$-x + 5$"], answer: "$-x + 5$", process: "\\begin{aligned} & -2(4x + 1) + 7(x + 1) \\\\ &= -8x - 2 + 7x + 7 \\\\ &= (-8x + 7x) + (-2 + 7) \\\\ &= -x + 5 \\end{aligned}" },
  { question: "10(x - 1) - 8(x - 2)", choices: ["$2x - 26$", "$2x - 18$", "$18x + 6$", "$2x + 6$"], answer: "$2x + 6$", process: "\\begin{aligned} & 10(x - 1) - 8(x - 2) \\\\ &= 10x - 10 - 8x + 16 \\\\ &= (10x - 8x) + (-10 + 16) \\\\ &= 2x + 6 \\end{aligned}" },
  { question: "-(x + 3) + 5(2x - 1)", choices: ["$9x - 2$", "$11x - 8$", "$9x + 2$", "$9x - 8$"], answer: "$9x - 8$", process: "\\begin{aligned} & -(x + 3) + 5(2x - 1) \\\\ &= -x - 3 + 10x - 5 \\\\ &= (-x + 10x) + (-3 - 5) \\\\ &= 9x - 8 \\end{aligned}" },
  { question: "3(x + 5) - 10(x - 1)", choices: ["$-7x + 5$", "$-7x + 15$", "$13x + 25$", "$-7x + 25$"], answer: "$-7x + 25$", process: "\\begin{aligned} & 3(x + 5) - 10(x - 1) \\\\ &= 3x + 15 - 10x + 10 \\\\ &= (3x - 10x) + (15 + 10) \\\\ &= -7x + 25 \\end{aligned}" },
  { question: "7(2x - 1) + (x + 8)", choices: ["$15x + 7$", "$13x + 1$", "$15x - 1$", "$15x + 1$"], answer: "$15x + 1$", process: "\\begin{aligned} & 7(2x - 1) + (x + 8) \\\\ &= 14x - 7 + x + 8 \\\\ &= (14x + x) + (-7 + 8) \\\\ &= 15x + 1 \\end{aligned}" },
  { question: "-9(x - 1) - (2x + 7)", choices: ["$-11x - 16$", "$-11x - 4$", "$-7x + 16$", "$-11x + 2$"], answer: "$-11x + 2$", process: "\\begin{aligned} & -9(x - 1) - (2x + 7) \\\\ &= -9x + 9 - 2x - 7 \\\\ &= (-9x - 2x) + (9 - 7) \\\\ &= -11x + 2 \\end{aligned}" }, // Corrected duplicate
  { question: "5(3x + 1) - 12(x - 1)", choices: ["$3x - 7$", "$3x + 13$", "$27x + 17$", "$3x + 17$"], answer: "$3x + 17$", process: "\\begin{aligned} & 5(3x + 1) - 12(x - 1) \\\\ &= 15x + 5 - 12x + 12 \\\\ &= (15x - 12x) + (5 + 12) \\\\ &= 3x + 17 \\end{aligned}" },
  { question: "-(8x - 5) + 6(x + 1)", choices: ["$-2x + 6$", "$-2x - 1$", "$-14x + 11$", "$-2x + 11$"], answer: "$-2x + 11$", process: "\\begin{aligned} & -(8x - 5) + 6(x + 1) \\\\ &= -8x + 5 + 6x + 6 \\\\ &= (-8x + 6x) + (5 + 6) \\\\ &= -2x + 11 \\end{aligned}" },
  { question: "11(x - 1) - 9(x - 2)", choices: ["$2x - 29$", "$2x - 7$", "$20x + 7$", "$2x + 7$"], answer: "$2x + 7$", process: "\\begin{aligned} & 11(x - 1) - 9(x - 2) \\\\ &= 11x - 11 - 9x + 18 \\\\ &= (11x - 9x) + (-11 + 18) \\\\ &= 2x + 7 \\end{aligned}" }
];


 // ===== グローバル変数定義 =====
        const modeSelectionScreen = document.getElementById('mode-selection');
        const quizMainScreen = document.getElementById('quiz-main');
        const musouBackground = document.getElementById('musou-background');

        const questionArea = document.getElementById('question-area');
        const nextButton = document.getElementById('next-btn');
        const resultsArea = document.getElementById('results');
        const scoreDisplay = document.getElementById('score');
        const timerBar = document.getElementById('timer-bar');
        const timerText = document.getElementById('timer-text');
        
        let selectedQuizData;
        let currentQuestionIndex = 0;
        let score = 0;
        let currentMode = 'normal';
        
        let timerInterval;
        let timeLeft;
        let TIME_LIMIT;
        let WARNING_TIME;
        
        let totalSolveTime = 0;
        let questionStartTime;

        let currentRankSettings = {};

        // ===== モード選択とクイズ開始の処理 =====
        document.getElementById('normal-mode-btn').addEventListener('click', () => {
            startGame({
                mode: 'normal',
                // ★ 3. モード別設定 (test3.html 用) ★
                timeLimit: 15,     // ノーマル 制限時間
                warningTime: 5,      // ノーマル 警告時間
                isMusou: false,
                sRankTime: 40,  // Sランク基準 (例: 40秒)
                aRankTime: 60,  // Aランク基準 (例: 60秒)
                bRankTime: 90   // Bランク基準 (例: 90秒)
            });
        });

        document.getElementById('musou-mode-btn').addEventListener('click', () => {
            startGame({
                mode: 'musou',
                // ★ 3. モード別設定 (test3.html 用) ★
                timeLimit: 7,      // 無双 制限時間
                warningTime: 3,      // 無双 警告時間
                isMusou: true,
                sRankTime: 30,  // Sランク基準 (例: 30秒)
                aRankTime: 45,  // Aランク基準 (例: 45秒)
                bRankTime: 60   // Bランク基準 (例: 60秒)
            });
        });

        function startGame(settings) {
            currentMode = settings.mode; 
            TIME_LIMIT = settings.timeLimit;
            WARNING_TIME = settings.warningTime;
            
            currentRankSettings = {
                sRankTime: settings.sRankTime,
                aRankTime: settings.aRankTime,
                bRankTime: settings.bRankTime
            };

            if (settings.isMusou) {
                musouBackground.classList.remove('hidden');
            }

            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            const shuffledData = shuffleArray(fullQuizDataBank);
            selectedQuizData = shuffledData.slice(0, 10);

            modeSelectionScreen.classList.add('hidden');
            quizMainScreen.classList.remove('hidden');

            showQuestion();
        }


        // ===== タイマー関数 =====
        function startTimer() {
            timeLeft = TIME_LIMIT;
            timerText.textContent = timeLeft;
            timerBar.style.width = '100%';
            timerBar.classList.remove('warning');
            document.body.classList.remove('timer-warning');

            timerInterval = setInterval(() => {
                timeLeft--;
                timerText.textContent = timeLeft;
                timerBar.style.width = (timeLeft / TIME_LIMIT) * 100 + '%';

                if (timeLeft <= WARNING_TIME) {
                    timerBar.classList.add('warning');
                    document.body.classList.add('timer-warning');
                }

                if (timeLeft <= 0) {
                    timeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function timeUp() {
            stopTimer();
            totalSolveTime += TIME_LIMIT;

            const choicesContainer = questionArea.querySelector('.choices');
            const feedbackMessage = document.getElementById('feedback-message');
            const processDisplay = document.getElementById('calculation-process');
            const currentQuestion = selectedQuizData[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer.replace(/\$/g, ''); // $ 除去

            if(choicesContainer) {
                choicesContainer.classList.add('answered');
            }

            feedbackMessage.textContent = "時間切れ💦";
            feedbackMessage.classList.add('incorrect-feedback');
            feedbackMessage.classList.remove('hidden');

            katex.render(currentQuestion.process, processDisplay, { throwOnError: false, displayMode: true });
            processDisplay.classList.remove('hidden');

            Array.from(choicesContainer.children).forEach(child => {
                const choiceText = child.textContent.replace(/\$/g, ''); // $ 除去
                if (choiceText === correctAnswer) {
                     child.classList.add('correct');
                }
            });

            if (currentQuestionIndex < selectedQuizData.length - 1) {
                nextButton.innerText = "次の問題へ";
            } else {
                nextButton.innerText = "結果を見る";
            }
            nextButton.classList.remove('hidden');
        }

        // ===== クイズ本体の関数 (★ テンプレートA / test3用 ★) =====
        function showQuestion() {
            const currentQuestion = selectedQuizData[currentQuestionIndex];
            
            // 選択肢 ($あり) から $ を除去して onclick に設定
            const choicesHtml = currentQuestion.choices.map(choice => {
                const onclickChoice = choice.replace(/\$/g, ''); // $ 除去
                return `<div class="choice" onclick="selectAnswer(this, '${onclickChoice}')">${choice}</div>`;
            }).join('');

            questionArea.innerHTML = `
                <div class="question-block">
                    <div class="problem-text" id="problem-text"></div>
                    <div class="choices">${choicesHtml}</div>
                    <div class="feedback-area">
                        <p id="feedback-message" class="hidden"></p>
                        <div id="calculation-process" class="calculation-process hidden"></div>
                    </div>
                </div>
            `;
            
            // ★ 問題文は $ 除去不要 ★
            const problemTextElement = document.getElementById('problem-text');
            const questionKatexString = currentQuestion.question; // $ 除去しない
            try {
                katex.render(questionKatexString, problemTextElement, { 
                    throwOnError: true,
                    displayMode: true
                });
            } catch (e) {
                 console.error("KaTeX render error on question:", currentQuestion.question, e);
                 problemTextElement.textContent = currentQuestion.question;
            }

            // ★ 選択肢は $ 除去が必要 ★
            const choiceElements = questionArea.querySelectorAll('.choice');
            choiceElements.forEach(element => {
                const katexString = element.textContent.slice(1, -1); // $ 除去
                try {
                    katex.render(katexString, element, { 
                        throwOnError: true, 
                        displayMode: false 
                    }); 
                } catch (e) {
                    console.error("KaTeX render error on choice:", element.textContent, e); 
                    element.innerHTML = element.textContent; 
                }
            });
            
            questionStartTime = Date.now();
            startTimer();
        }

        function selectAnswer(element, selectedChoice) {
            stopTimer();
            const timeTaken = (Date.now() - questionStartTime) / 1000;
            totalSolveTime += timeTaken;

            const choicesContainer = element.parentElement;
            if (choicesContainer.classList.contains('answered')) return;
            choicesContainer.classList.add('answered');

            const currentQuestion = selectedQuizData[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer.replace(/\$/g, ''); // $ 除去

            const feedbackMessage = document.getElementById('feedback-message');
            const processDisplay = document.getElementById('calculation-process');

            if (selectedChoice === correctAnswer) { 
                score++;
                element.classList.add('correct');
                feedbackMessage.textContent = "正解💐";
                feedbackMessage.classList.add('correct-feedback');
            } else {
                element.classList.add('incorrect');
                feedbackMessage.textContent = "不正解💦";
                feedbackMessage.classList.add('incorrect-feedback');
                
                katex.render(currentQuestion.process, processDisplay, { throwOnError: false, displayMode: true });
                processDisplay.classList.remove('hidden');

                 // 正解の選択肢をハイライト
                Array.from(choicesContainer.children).forEach(child => {
                    const choiceText = child.textContent.replace(/\$/g, ''); // $ 除去
                    if (choiceText === correctAnswer) {
                         child.classList.add('correct');
                    }
                });
            }
            
            feedbackMessage.classList.remove('hidden');
            
            if (currentQuestionIndex < selectedQuizData.length - 1) {
                nextButton.innerText = "次の問題へ";
            } else {
                nextButton.innerText = "結果を見る";
            }
            nextButton.classList.remove('hidden');
        }

        nextButton.addEventListener('click', () => {
            currentQuestionIndex++;
            document.body.classList.remove('timer-warning');
            if (currentQuestionIndex < selectedQuizData.length) {
                showQuestion();
                nextButton.classList.add('hidden');
            } else {
                showResults();
            }
        });

        function showResults() {
            questionArea.classList.add('hidden');
            nextButton.classList.add('hidden');
            document.querySelector('.timer-container').classList.add('hidden');
            
            const finalScore = score * 10;
            const totalPoints = selectedQuizData.length * 10;
            const totalSeconds = Math.round(totalSolveTime);

            let rank = '';
            let rankColor = '';
            let rankName = '';

            if (totalSeconds <= currentRankSettings.sRankTime) {
                rank = '⭐️ Sランク ⭐️'; rankColor = '#ffc107';
                rankName = 'S';
            } else if (totalSeconds <= currentRankSettings.aRankTime) {
                rank = '🌛 Aランク 🌛'; rankColor = '#6c757d';
                rankName = 'A';
            } else if (totalSeconds <= currentRankSettings.bRankTime) {
                rank = '🌲 Bランク 🌲'; rankColor = '#cd7f32';
                rankName = 'B';
            } else {
                rank = '💪 Cランク 💪'; rankColor = '#28a745';
                rankName = 'C';
            }
            
            // ★ 4. 達成状況（スター/クラウン）の保存処理 ★
            
            // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
            // ★ ↓↓↓ この testId をファイルごとに変更してください ↓↓↓ ★
            const thisTestId = "test3"; // ★ test3.html なので "test3" ★
            // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

            // ★ 5. 履歴キー（ファイルごとに変える） ★
            const historyKey = 'algebraHistory'; // ★「文字式」用のキー

            // --- 達成状況の保存ロジック ---
            let achievements = JSON.parse(localStorage.getItem('quizAchievements')) || {};
            const currentBest = achievements[thisTestId]; 
            
            let newLevel = ''; // このラウンドで達成したレベル
            let shouldUpdate = false; // 保存を更新すべきか
            let trophyMessage = ''; // ★ 表示するメッセージ用変数を追加

            // 1. 満点かどうかをまず確認
            if (finalScore === totalPoints) {
                
                // 2. 満点の場合、ランクを確認
                if (rankName === 'S' || rankName === 'A') {
                    newLevel = (currentMode === 'musou') ? 'musou' : 'normal';
                } else {
                    newLevel = 'apple';
                }

                // 3. 達成状況を更新 (格下げはしない)
                if (newLevel === 'musou') {
                    shouldUpdate = true;
                } else if (newLevel === 'normal' && (currentBest !== 'musou')) {
                    shouldUpdate = true;
                } else if (newLevel === 'apple' && (currentBest !== 'musou' && currentBest !== 'normal')) {
                    shouldUpdate = true;
                }

                if (shouldUpdate) {
                    achievements[thisTestId] = newLevel;
                    localStorage.setItem('quizAchievements', JSON.stringify(achievements));
                    
                    // ★ メッセージをセット ★
                    if (newLevel === 'musou') {
                        trophyMessage = '👑をゲットしました！';
                    } else if (newLevel === 'normal') {
                        trophyMessage = '⭐をゲットしました！';
                    } else if (newLevel === 'apple') {
                        trophyMessage = '🍎をゲットしました！';
                    }
                }
            }
            // --- 達成状況の保存ロジックここまで ---
            
            // --- 履歴保存処理 ---
             const newResult = {
                score: finalScore,
                totalPoints: totalPoints,
                time: totalSeconds,
                rank: rankName, 
                date: new Date().toLocaleString('ja-JP') 
            };
            let history = JSON.parse(localStorage.getItem(historyKey)) || [];
            history.unshift(newResult);
            localStorage.setItem(historyKey, JSON.stringify(history)); 
            // --- 保存処理ここまで ---

            resultsArea.classList.remove('hidden');
            
            const timeInfoDisplay = document.getElementById('time-info');
            const rankInfoDisplay = document.getElementById('rank-info');

            scoreDisplay.textContent = `${finalScore}点 / ${totalPoints}点満点`;
            timeInfoDisplay.textContent = `合計解答時間: ${totalSeconds}秒`;
            rankInfoDisplay.textContent = rank; 
            rankInfoDisplay.style.color = rankColor;
        }
        
    </script>

</body>
</html>
