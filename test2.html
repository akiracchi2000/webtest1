<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë®àÁÆó„ÉÜ„Çπ„Éà (ÂàùÁ¥ö)</title>
    
    <link rel="stylesheet" href="./katex/katex.min.css">
    <script defer src="./katex/katex.min.js"></script>

    <style>
        /* „Éö„Éº„Ç∏„ÅÆÂü∫Êú¨„Çπ„Çø„Ç§„É´ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f7f6;
            transition: background-color 0.5s ease;
        }
        
        body.timer-warning {
            background-color: #ffebee;
        }

        /* ===== „É¢„Éº„ÉâÈÅ∏ÊäûÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ ===== */
        #mode-selection {
            text-align: center;
            background: #fff;
            padding: 3em;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        #mode-selection h1 {
            color: #2c3e50;
            margin-top: 0;
        }
        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 1em;
        }
        .mode-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: #fff;
            font-weight: bold;
        }
        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #normal-mode-btn {
            background-color: #3498db;
        }
        #musou-mode-btn {
            background-color: #c0392b;
        }

        /* ===== ÁÑ°Âèå„É¢„Éº„ÉâÁî®„ÅÆËÉåÊôØÁîªÂÉè ===== */
        #musou-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('./hannya.png'); /* ÁîªÂÉè„Éë„Çπ */
            background-repeat: repeat;
            background-size: 100px; 
            background-position: center;
            opacity: 0.15;
            z-index: -1;
        }

        /* „ÇØ„Ç§„Ç∫ÂÖ®‰Ωì„ÅÆ„Ç≥„É≥„ÉÜ„Éä */
        .quiz-container {
            max-width: 600px;
            width: 90%;
            background: #fff;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }

        .timer-container {
            position: relative;
            width: 100%;
            height: 25px;
            background-color: #e9ecef;
            border-radius: 15px;
            margin-bottom: 1.5em;
            overflow: hidden;
        }
        .timer-bar {
            height: 100%;
            width: 100%;
            background-color: #3498db;
            border-radius: 15px;
            transition: width 1s linear, background-color 0.5s ease;
        }
        .timer-bar.warning {
            background-color: #dc3545;
        }
        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-weight: bold;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin: 0 0 1em 0;
        }

        .problem-text { font-size: 2em; margin-bottom: 1em; text-align: center; min-height: 50px; }
        .choices { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .choice { display: block; background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: background-color 0.2s, transform 0.2s; border: 2px solid transparent; font-size: 1.2em; }
        .choice:hover { background-color: #d1d9e0; }
        .choice.correct { background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724; font-weight: bold; }
        .choice.incorrect { background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24; }
        .choices.answered { pointer-events: none; }
        .choices.answered .choice:not(.correct):not(.incorrect) { opacity: 0.6; }
        .feedback-area { margin-top: 1.5em; min-height: 150px; }
        .feedback-message { font-size: 2.5em; font-weight: bold; text-align: center; margin: 0 0 15px 0; }
        .feedback-message.correct-feedback { color: #28a745; }
        .feedback-message.incorrect-feedback { color: #dc3545; }
        .calculation-process { background-color: #f8f9fa; border-radius: 5px; padding: 15px; font-size: 1.1em; border-left: 5px solid #6c757d; }
        .katex-display { text-align: left !important; }
        .controls { text-align: center; margin-top: 1em; height: 50px; }
        #next-btn { padding: 12px 35px; font-size: 1.1em; color: #fff; background-color: #3498db; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        #next-btn:hover { background-color: #2980b9; }
        
        #results { text-align: center; }
        #results h2 { color: #2c3e50; }
        #results #score { font-size: 2em; font-weight: bold; color: #3498db; margin: 0.5em 0; }
        #results #time-info { font-size: 1.2em; color: #6c757d; margin: 0.5em 0; }
        #results #rank-info { font-size: 2.5em; font-weight: bold; margin: 0.5em 0; }
        #results .sub-message { font-size: 1em; color: #6c757d; margin-top: 0.5em;}
        
        .hidden { display: none; }
        
        /* ===== „Éà„ÉÉ„Éó„Å∏Êàª„Çã„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ ===== */
        .home-btn {
            display: inline-block;
            margin-top: 1.5em;
            padding: 10px 25px;
            font-size: 1em;
            text-decoration: none;
            color: #fff;
            background-color: #6c757d;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .home-btn:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

    <div id="mode-selection">
        <h1>„É¢„Éº„Éâ„ÇíÈÅ∏Êäû</h1>
        <div class="mode-buttons">
            <button id="normal-mode-btn" class="mode-btn">‚úíÔ∏è„Éé„Éº„Éû„É´„É¢„Éº„Éâ‚úíÔ∏è</button>
            <button id="musou-mode-btn" class="mode-btn">‚öîÔ∏èÁÑ°Âèå„É¢„Éº„Éâ‚öîÔ∏è</button>
            </div>
        <a href="./index.html" class="home-btn" style="margin-top: 2em;">„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Çã</a>
    </div>

    <div class="quiz-container hidden" id="quiz-main">
        <div class="timer-container">
            <div class="timer-bar" id="timer-bar"></div>
            <span class="timer-text" id="timer-text"></span>
        </div>
        
        <h1>Ë®àÁÆó„ÉÜ„Çπ„Éà (ÂàùÁ¥ö)</h1>
        <div id="question-area"></div>
        
        <div id="results" class="hidden">
            <h2>„ÉÜ„Çπ„ÉàÁµÇ‰∫ÜÔºÅ</h2>
            <p id="score"></p>
            <p id="time-info"></p>
            <p id="rank-info"></p>
            <p class="sub-message">„ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ</p>
            <a href="./index.html" class="home-btn">„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Çã</a>
        </div>
        
        <div class="controls">
            <button id="next-btn" class="hidden">Ê¨°„ÅÆÂïèÈ°å„Å∏</button>
        </div>
    </div>

    <div id="musou-background" class="hidden"></div>


    <script>
        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
        // ‚òÖ 
        // ‚òÖ  const fullQuizDataBank = [ ... ];
        // ‚òÖ  (‚Üë „Åì„Åì„Å´100Âïè„ÅÆ„Éá„Éº„Çø„Éê„É≥„ÇØ„ÇíË≤º„Çä‰ªò„Åë)
        // ‚òÖ 
        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ


        // ===== „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ÂÆöÁæ© =====
        const modeSelectionScreen = document.getElementById('mode-selection');
        const quizMainScreen = document.getElementById('quiz-main');
        const musouBackground = document.getElementById('musou-background');

        const questionArea = document.getElementById('question-area');
        const nextButton = document.getElementById('next-btn');
        const resultsArea = document.getElementById('results');
        const scoreDisplay = document.getElementById('score');
        const timerBar = document.getElementById('timer-bar');
        const timerText = document.getElementById('timer-text');
        
        let selectedQuizData;
        let currentQuestionIndex = 0;
        let score = 0;
        let currentMode = 'normal'; // ÁèæÂú®„ÅÆ„É¢„Éº„Éâ„Çí‰øùÂ≠ò
        
        let timerInterval;
        let timeLeft;
        let TIME_LIMIT;
        let WARNING_TIME;
        
        let totalSolveTime = 0;
        let questionStartTime;

        let currentRankSettings = {}; // „É©„É≥„ÇØÂà§ÂÆöÂü∫Ê∫ñ„Çí‰øùÂ≠ò

        // ===== „É¢„Éº„ÉâÈÅ∏Êäû„Å®„ÇØ„Ç§„Ç∫ÈñãÂßã„ÅÆÂá¶ÁêÜ =====
        document.getElementById('normal-mode-btn').addEventListener('click', () => {
            startGame({
                mode: 'normal',
                // ‚òÖ 3. „É¢„Éº„ÉâÂà•Ë®≠ÂÆöÔºà„Éï„Ç°„Ç§„É´„Åî„Å®„Å´Â§â„Åà„ÇãÔºâ ‚òÖ
                timeLimit: 15,     // „Éé„Éº„Éû„É´ Âà∂ÈôêÊôÇÈñì15Áßí
                warningTime: 5,      // „Éé„Éº„Éû„É´ Ë≠¶Âëä„ÅØÊÆã„Çä5Áßí
                isMusou: false,
                sRankTime: 30,  
                aRankTime: 45,  
                bRankTime: 60   
            });
        });

        document.getElementById('musou-mode-btn').addEventListener('click', () => {
            startGame({
                mode: 'musou',
                // ‚òÖ 3. „É¢„Éº„ÉâÂà•Ë®≠ÂÆöÔºà„Éï„Ç°„Ç§„É´„Åî„Å®„Å´Â§â„Åà„ÇãÔºâ ‚òÖ
                timeLimit: 5,      // ÁÑ°Âèå Âà∂ÈôêÊôÇÈñì5Áßí
                warningTime: 3,      // ÁÑ°Âèå Ë≠¶Âëä„ÅØÊÆã„Çä3Áßí
                isMusou: true,
                sRankTime: 20,  
                aRankTime: 30,  
                bRankTime: 40   
            });
        });

        function startGame(settings) {
            currentMode = settings.mode; 
            TIME_LIMIT = settings.timeLimit;
            WARNING_TIME = settings.warningTime;
            
            currentRankSettings = {
                sRankTime: settings.sRankTime,
                aRankTime: settings.aRankTime,
                bRankTime: settings.bRankTime
            };

            if (settings.isMusou) {
                musouBackground.classList.remove('hidden');
            }

            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            const shuffledData = shuffleArray(fullQuizDataBank);
            selectedQuizData = shuffledData.slice(0, 10);

            modeSelectionScreen.classList.add('hidden');
            quizMainScreen.classList.remove('hidden');

            showQuestion();
        }


        // ===== „Çø„Ç§„Éû„ÉºÈñ¢Êï∞ =====
        function startTimer() {
            timeLeft = TIME_LIMIT;
            timerText.textContent = timeLeft;
            timerBar.style.width = '100%';
            timerBar.classList.remove('warning');
            document.body.classList.remove('timer-warning');

            timerInterval = setInterval(() => {
                timeLeft--;
                timerText.textContent = timeLeft;
                timerBar.style.width = (timeLeft / TIME_LIMIT) * 100 + '%';

                if (timeLeft <= WARNING_TIME) {
                    timerBar.classList.add('warning');
                    document.body.classList.add('timer-warning');
                }

                if (timeLeft <= 0) {
                    timeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function timeUp() {
            stopTimer();
            totalSolveTime += TIME_LIMIT;

            const choicesContainer = questionArea.querySelector('.choices');
            const feedbackMessage = document.getElementById('feedback-message');
            const processDisplay = document.getElementById('calculation-process');
            const currentQuestion = selectedQuizData[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer.replace(/\$/g, ''); 

            if(choicesContainer) {
                choicesContainer.classList.add('answered');
            }

            feedbackMessage.textContent = "ÊôÇÈñìÂàá„Çåüí¶";
            feedbackMessage.classList.add('incorrect-feedback');
            feedbackMessage.classList.remove('hidden');

            katex.render(currentQuestion.process, processDisplay, { throwOnError: false, displayMode: true });
            processDisplay.classList.remove('hidden');

            Array.from(choicesContainer.children).forEach(child => {
                const choiceText = child.textContent.replace(/\$/g, ''); 
                if (choiceText === correctAnswer) {
                     child.classList.add('correct');
                }
            });

            if (currentQuestionIndex < selectedQuizData.length - 1) {
                nextButton.innerText = "Ê¨°„ÅÆÂïèÈ°å„Å∏";
            } else {
                nextButton.innerText = "ÁµêÊûú„ÇíË¶ã„Çã";
            }
            nextButton.classList.remove('hidden');
        }

        // ===== „ÇØ„Ç§„Ç∫Êú¨‰Ωì„ÅÆÈñ¢Êï∞ =====
        function showQuestion() {
            const currentQuestion = selectedQuizData[currentQuestionIndex];
            
            const choicesHtml = currentQuestion.choices.map(choice => {
                const onclickChoice = choice.replace(/\$/g, ''); 
                return `<div class="choice" onclick="selectAnswer(this, '${onclickChoice}')">${choice}</div>`;
            }).join('');

            questionArea.innerHTML = `
                <div class="question-block">
                    <div class="problem-text" id="problem-text"></div>
                    <div class="choices">${choicesHtml}</div>
                    <div class="feedback-area">
                        <p id="feedback-message" class="hidden"></p>
                        <div id="calculation-process" class="calculation-process hidden"></div>
                    </div>
                </div>
            `;
            
            const problemTextElement = document.getElementById('problem-text');
            const questionKatexString = currentQuestion.question.slice(1, -1); 
            try {
                katex.render(questionKatexString, problemTextElement, { 
                    throwOnError: true,
                    displayMode: true
                });
            } catch (e) {
                 console.error("KaTeX render error on question:", currentQuestion.question, e);
                 problemTextElement.textContent = currentQuestion.question;
            }

            const choiceElements = questionArea.querySelectorAll('.choice');
            choiceElements.forEach(element => {
                // $ „ÇíÂê´„Åæ„Å™„ÅÑÈÅ∏ÊäûËÇ¢ÔºàÊï¥Êï∞„ÅÆÁ≠î„Åà„Å™„Å©Ôºâ„ÅÆÂ†¥Âêà„ÄÅ„Ç®„É©„Éº„ÇíÈÅø„Åë„Çã
                let katexString = element.textContent;
                if (katexString.startsWith('$') && katexString.endsWith('$')) {
                     katexString = katexString.slice(1, -1); 
                }

                try {
                    katex.render(katexString, element, { 
                        throwOnError: true, 
                        displayMode: false 
                    }); 
                } catch (e) {
                    console.error("KaTeX render error on choice:", element.textContent, e); 
                    element.innerHTML = element.textContent; 
                }
            });
            
            questionStartTime = Date.now();
            startTimer();
        }

        function selectAnswer(element, selectedChoice) {
            stopTimer();
            const timeTaken = (Date.now() - questionStartTime) / 1000;
            totalSolveTime += timeTaken;

            const choicesContainer = element.parentElement;
            if (choicesContainer.classList.contains('answered')) return;
            choicesContainer.classList.add('answered');

            const currentQuestion = selectedQuizData[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer.replace(/\$/g, ''); 

            const feedbackMessage = document.getElementById('feedback-message');
            const processDisplay = document.getElementById('calculation-process');

            if (selectedChoice === correctAnswer) { 
                score++;
                element.classList.add('correct');
                feedbackMessage.textContent = "Ê≠£Ëß£üíê";
                feedbackMessage.classList.add('correct-feedback');
            } else {
                element.classList.add('incorrect');
                feedbackMessage.textContent = "‰∏çÊ≠£Ëß£üí¶";
                feedbackMessage.classList.add('incorrect-feedback');
                
                katex.render(currentQuestion.process, processDisplay, { throwOnError: false, displayMode: true });
                processDisplay.classList.remove('hidden');

                 // Ê≠£Ëß£„ÅÆÈÅ∏ÊäûËÇ¢„Çí„Éè„Ç§„É©„Ç§„Éà
                Array.from(choicesContainer.children).forEach(child => {
                    const choiceText = child.textContent.replace(/\$/g, ''); 
                    if (choiceText === correctAnswer) {
                         child.classList.add('correct');
                    }
                });
            }
            
            feedbackMessage.classList.remove('hidden');
            
            if (currentQuestionIndex < selectedQuizData.length - 1) {
                nextButton.innerText = "Ê¨°„ÅÆÂïèÈ°å„Å∏";
            } else {
                nextButton.innerText = "ÁµêÊûú„ÇíË¶ã„Çã";
            }
            nextButton.classList.remove('hidden');
        }

        nextButton.addEventListener('click', () => {
            currentQuestionIndex++;
            document.body.classList.remove('timer-warning');
            if (currentQuestionIndex < selectedQuizData.length) {
                showQuestion();
                nextButton.classList.add('hidden');
            } else {
                showResults();
            }
        });

        function showResults() {
            questionArea.classList.add('hidden');
            nextButton.classList.add('hidden');
            document.querySelector('.timer-container').classList.add('hidden');
            
            const finalScore = score * 10;
            const totalPoints = selectedQuizData.length * 10;
            const totalSeconds = Math.round(totalSolveTime);

            let rank = '';
            let rankColor = '';
            let rankName = '';

            if (totalSeconds <= currentRankSettings.sRankTime) {
                rank = '‚≠êÔ∏è S„É©„É≥„ÇØ ‚≠êÔ∏è'; rankColor = '#ffc107';
                rankName = 'S';
            } else if (totalSeconds <= currentRankSettings.aRankTime) {
                rank = 'üåõ A„É©„É≥„ÇØ üåõ'; rankColor = '#6c757d';
                rankName = 'A';
            } else if (totalSeconds <= currentRankSettings.bRankTime) {
                rank = 'üå≤ B„É©„É≥„ÇØ üå≤'; rankColor = '#cd7f32';
                rankName = 'B';
            } else {
                rank = 'üí™ C„É©„É≥„ÇØ üí™'; rankColor = '#28a745';
                rankName = 'C';
            }
            
            // ‚òÖ 4. ÈÅîÊàêÁä∂Ê≥ÅÔºà„Çπ„Çø„Éº/„ÇØ„É©„Ç¶„É≥Ôºâ„ÅÆ‰øùÂ≠òÂá¶ÁêÜ ‚òÖ
            
            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
            // ‚òÖ ‚Üì‚Üì‚Üì „Åì„ÅÆ testId „Çí„Éï„Ç°„Ç§„É´„Åî„Å®„Å´Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ ‚Üì‚Üì‚Üì ‚òÖ
            const thisTestId = "test2"; 
            // ‚òÖ (‰æã: test2.html „Å™„Çâ "test2" „Å´„Åô„Çã) ‚òÖ
            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ

            // ‚òÖ 5. Â±•Ê≠¥„Ç≠„ÉºÔºà„Éï„Ç°„Ç§„É´„Åî„Å®„Å´Â§â„Åà„ÇãÔºâ ‚òÖ
            const historyKey = 'calcHistory'; // ‚òÖ„ÄåÊ≠£Ë≤†„ÅÆÊï∞„ÄçÁî®„ÅÆ„Ç≠„Éº
            
            if (finalScore === totalPoints && (rankName === 'S' || rankName === 'A')) {
                let achievements = JSON.parse(localStorage.getItem('quizAchievements')) || {};
                const newLevel = (currentMode === 'musou') ? 'musou' : 'normal';
                const currentBest = achievements[thisTestId]; 

                if (newLevel === 'musou' || currentBest !== 'musou') {
                    achievements[thisTestId] = newLevel;
                    localStorage.setItem('quizAchievements', JSON.stringify(achievements));
                }
            }
            
            // --- Â±•Ê≠¥‰øùÂ≠òÂá¶ÁêÜ ---
             const newResult = {
                score: finalScore,
                totalPoints: totalPoints,
                time: totalSeconds,
                rank: rankName, 
                date: new Date().toLocaleString('ja-JP') 
            };
            let history = JSON.parse(localStorage.getItem(historyKey)) || [];
            history.unshift(newResult);
            localStorage.setItem(historyKey, JSON.stringify(history)); 
            // --- ‰øùÂ≠òÂá¶ÁêÜ„Åì„Åì„Åæ„Åß ---

            resultsArea.classList.remove('hidden');
            
            const timeInfoDisplay = document.getElementById('time-info');
            const rankInfoDisplay = document.getElementById('rank-info');

            scoreDisplay.textContent = `${finalScore}ÁÇπ / ${totalPoints}ÁÇπÊ∫ÄÁÇπ`;
            timeInfoDisplay.textContent = `ÂêàË®àËß£Á≠îÊôÇÈñì: ${totalSeconds}Áßí`;
            rankInfoDisplay.textContent = rank; 
            rankInfoDisplay.style.color = rankColor;
        }
        
    </script>

</body>
</html>
