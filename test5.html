<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>計算テスト (モード選択)</title>
    
    <link rel="stylesheet" href="./katex/katex.min.css">
    <script defer src="./katex/katex.min.js"></script>

    <style>
        /* ページの基本スタイル */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f7f6;
            transition: background-color 0.5s ease;
        }
        
        body.timer-warning {
            background-color: #ffebee;
        }

        /* ===== モード選択画面のスタイル ===== */
        #mode-selection {
            text-align: center;
            background: #fff;
            padding: 3em;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        #mode-selection h1 {
            color: #2c3e50;
            margin-top: 0;
        }
        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 1em;
        }
        .mode-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: #fff;
            font-weight: bold;
        }
        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #normal-mode-btn {
            background-color: #3498db;
        }
        #musou-mode-btn {
            background-color: #c0392b;
        }

#musou-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('./hannya.png');
            background-repeat: repeat;   /* 画像を繰り返して表示 */
            background-size: 100px;      /* 画像のサイズを小さく設定 */
            background-position: center; /* 念のため中央配置も残しておく */
            opacity: 0.15;
            z-index: -1;
        }        /* クイズ全体のコンテナ */
        .quiz-container {
            max-width: 600px;
            width: 90%;
            background: #fff;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }

        .timer-container {
            position: relative;
            width: 100%;
            height: 25px;
            background-color: #e9ecef;
            border-radius: 15px;
            margin-bottom: 1.5em;
            overflow: hidden;
        }
        .timer-bar {
            height: 100%;
            width: 100%;
            background-color: #3498db;
            border-radius: 15px;
            transition: width 1s linear, background-color 0.5s ease;
        }
        .timer-bar.warning {
            background-color: #dc3545;
        }
        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-weight: bold;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin: 0 0 1em 0;
        }

        .problem-text { font-size: 2em; margin-bottom: 1em; text-align: center; min-height: 50px; }
        .choices { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .choice { display: block; background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: background-color 0.2s, transform 0.2s; border: 2px solid transparent; font-size: 1.2em; }
        .choice:hover { background-color: #d1d9e0; }
        .choice.correct { background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724; font-weight: bold; }
        .choice.incorrect { background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24; }
        .choices.answered { pointer-events: none; }
        .choices.answered .choice:not(.correct):not(.incorrect) { opacity: 0.6; }
        .feedback-area { margin-top: 1.5em; min-height: 150px; }
        .feedback-message { font-size: 2.5em; font-weight: bold; text-align: center; margin: 0 0 15px 0; }
        .feedback-message.correct-feedback { color: #28a745; }
        .feedback-message.incorrect-feedback { color: #dc3545; }
        .calculation-process { background-color: #f8f9fa; border-radius: 5px; padding: 15px; font-size: 1.1em; border-left: 5px solid #6c757d; }
        .katex-display { text-align: left !important; }
        .controls { text-align: center; margin-top: 1em; height: 50px; }
        #next-btn { padding: 12px 35px; font-size: 1.1em; color: #fff; background-color: #3498db; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        #next-btn:hover { background-color: #2980b9; }
        #results { text-align: center; }
        #results h2 { color: #2c3e50; }
        #results #score { font-size: 2em; font-weight: bold; color: #3498db; margin: 0.5em 0; }
        #results #time-info { font-size: 1.2em; color: #6c757d; margin: 0.5em 0; }
        #results #rank-info { font-size: 2.5em; font-weight: bold; margin: 0.5em 0; }
        #results .sub-message { font-size: 1em; color: #6c757d; margin-top: 0.5em;}
        .hidden { display: none; }
        /* ===== トップへ戻るボタンのスタイル ===== */
        .home-btn {
            display: inline-block; /* ボタンのように振る舞わせる */
            margin-top: 1.5em;
            padding: 10px 25px;
            font-size: 1em;
            text-decoration: none;
            color: #fff;
            background-color: #6c757d; /* 落ち着いたグレー */
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .home-btn:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

    <div id="mode-selection">
        <h1>モードを選択</h1>
        <div class="mode-buttons">
            <button id="normal-mode-btn" class="mode-btn">✒️ノーマルモード✒️</button>
            <button id="musou-mode-btn" class="mode-btn">⚔️無双モード⚔️</button>
        </div>
        <a href="./index.html" class="home-btn" style="margin-top: 2em;">トップページに戻る</a>
        <!-- <p style="margin-top: 2em; color: #6c757d;">
            ノーマル: 15秒 / 警告5秒<br>
            無双: 5秒 / 警告3秒
        </p> -->
    </div>

    <div class="quiz-container hidden" id="quiz-main">
        <div class="timer-container">
            <div class="timer-bar" id="timer-bar"></div>
            <span class="timer-text" id="timer-text"></span>
        </div>
        
        <h1>計算テスト</h1>
        <div id="question-area"></div>
        
        <div id="results" class="hidden">
            <h2>テスト終了！</h2>
            <p id="score"></p>
            <p id="time-info"></p>
            <p id="rank-info"></p>
            <p class="sub-message">お疲れ様でした！</p>
            <a href="./index.html" class="home-btn">トップページに戻る</a>
        </div>
        
        <div class="controls">
            <button id="next-btn" class="hidden">次の問題へ</button>
        </div>
    </div>

    <div id="musou-background" class="hidden"></div>


    <script>
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ ここに、ご自身で作成した問題データを貼り付けてください ★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
// ===== 全100問の問題データバンク (分数係数1次式整理・$付き・トラップ付き・正解位置均等・選択肢修正v2) =====
const fullQuizDataBank = [
  // --- 【1番目が正解の問題】 (25問) ---
  { question: "$\\frac{x+1}{2} + \\frac{x-1}{3}$", choices: ["$\\frac{5x+1}{6}$", "$\\frac{2x}{5}$", "$\\frac{5x+5}{6}$", "$x$"], answer: "$\\frac{5x+1}{6}$", process: "\\begin{aligned} & \\frac{x+1}{2} + \\frac{x-1}{3} \\\\ &= \\frac{3(x+1) + 2(x-1)}{6} \\\\ &= \\frac{3x+3 + 2x-2}{6} \\\\ &= \\frac{5x+1}{6} \\end{aligned}" },
  { question: "$\\frac{2x-1}{3} - \\frac{x+2}{4}$", choices: ["$\\frac{5x-10}{12}$", "$\\frac{x-3}{ -1}$", "$\\frac{5x+2}{12}$", "$\\frac{11x-10}{12}$"], answer: "$\\frac{5x-10}{12}$", process: "\\begin{aligned} & \\frac{2x-1}{3} - \\frac{x+2}{4} \\\\ &= \\frac{4(2x-1) - 3(x+2)}{12} \\\\ &= \\frac{8x-4 - 3x-6}{12} \\\\ &= \\frac{5x-10}{12} \\end{aligned}" },
  { question: "$x + \\frac{x-3}{2}$", choices: ["$\\frac{3x-3}{2}$", "$\\frac{2x-3}{2}$", "$2x-3$", "$\\frac{x-3}{2}$"], answer: "$\\frac{3x-3}{2}$", process: "\\begin{aligned} & x + \\frac{x-3}{2} \\\\ &= \\frac{2x}{2} + \\frac{x-3}{2} \\\\ &= \\frac{2x + x-3}{2} \\\\ &= \\frac{3x-3}{2} \\end{aligned}" },
  { question: "$\\frac{3x+2}{5} - \\frac{x-1}{2}$", choices: ["$\\frac{x+9}{10}$", "$\\frac{2x+3}{3}$", "$\\frac{x-1}{10}$", "$\\frac{11x-1}{10}$"], answer: "$\\frac{x+9}{10}$", process: "\\begin{aligned} & \\frac{3x+2}{5} - \\frac{x-1}{2} \\\\ &= \\frac{2(3x+2) - 5(x-1)}{10} \\\\ &= \\frac{6x+4 - 5x+5}{10} \\\\ &= \\frac{x+9}{10} \\end{aligned}" },
  { question: "$\\frac{x}{3} + \\frac{2x+1}{6}$", choices: ["$\\frac{4x+1}{6}$", "$\\frac{3x+1}{9}$", "$\\frac{4x+1}{18}$", "$\\frac{x+1}{6}$"], answer: "$\\frac{4x+1}{6}$", process: "\\begin{aligned} & \\frac{x}{3} + \\frac{2x+1}{6} \\\\ &= \\frac{2x}{6} + \\frac{2x+1}{6} \\\\ &= \\frac{2x + 2x+1}{6} \\\\ &= \\frac{4x+1}{6} \\end{aligned}" },
  { question: "$2x - \\frac{x+4}{3}$", choices: ["$\\frac{5x-4}{3}$", "$\\frac{x-4}{3}$", "$5x-4$", "$\\frac{7x+4}{3}$"], answer: "$\\frac{5x-4}{3}$", process: "\\begin{aligned} & 2x - \\frac{x+4}{3} \\\\ &= \\frac{6x}{3} - \\frac{x+4}{3} \\\\ &= \\frac{6x - (x+4)}{3} \\\\ &= \\frac{6x-x-4}{3} \\\\ &= \\frac{5x-4}{3} \\end{aligned}" },
  { question: "$\\frac{-x+1}{4} + \\frac{2x-3}{2}$", choices: ["$\\frac{3x-5}{4}$", "$\\frac{x-2}{6}$", "$\\frac{3x-7}{4}$", "$\\frac{-5x+7}{4}$"], answer: "$\\frac{3x-5}{4}$", process: "\\begin{aligned} & \\frac{-x+1}{4} + \\frac{2x-3}{2} \\\\ &= \\frac{-x+1 + 2(2x-3)}{4} \\\\ &= \\frac{-x+1 + 4x-6}{4} \\\\ &= \\frac{3x-5}{4} \\end{aligned}" },
  { question: "$\\frac{x-5}{6} - \\frac{3x+1}{3}$", choices: ["$\\frac{-5x-7}{6}$", "$\\frac{-2x-6}{3}$", "$\\frac{-5x-3}{6}$", "$\\frac{7x+7}{6}$"], answer: "$\\frac{-5x-7}{6}$", process: "\\begin{aligned} & \\frac{x-5}{6} - \\frac{3x+1}{3} \\\\ &= \\frac{x-5 - 2(3x+1)}{6} \\\\ &= \\frac{x-5 - 6x-2}{6} \\\\ &= \\frac{-5x-7}{6} \\end{aligned}" },
  { question: "$\\frac{5x-1}{2} + x$", choices: ["$\\frac{7x-1}{2}$", "$\\frac{6x-1}{2}$", "$7x-1$", "$\\frac{5x}{2}$"], answer: "$\\frac{7x-1}{2}$", process: "\\begin{aligned} & \\frac{5x-1}{2} + x \\\\ &= \\frac{5x-1}{2} + \\frac{2x}{2} \\\\ &= \\frac{5x-1+2x}{2} \\\\ &= \\frac{7x-1}{2} \\end{aligned}" },
  { question: "$\\frac{x+7}{3} - 2x$", choices: ["$\\frac{-5x+7}{3}$", "$\\frac{-x+7}{3}$", "$-5x+7$", "$\\frac{7x+7}{3}$"], answer: "$\\frac{-5x+7}{3}$", process: "\\begin{aligned} & \\frac{x+7}{3} - 2x \\\\ &= \\frac{x+7}{3} - \\frac{6x}{3} \\\\ &= \\frac{x+7-6x}{3} \\\\ &= \\frac{-5x+7}{3} \\end{aligned}" },
  { question: "$\\frac{2(x-1)}{5} + \\frac{x+3}{2}$", choices: ["$\\frac{9x+11}{10}$", "$\\frac{3x+2}{7}$", "$\\frac{9x+19}{10}$", "$\\frac{4x+11}{10}$"], answer: "$\\frac{9x+11}{10}$", process: "\\begin{aligned} & \\frac{2(x-1)}{5} + \\frac{x+3}{2} \\\\ &= \\frac{2x-2}{5} + \\frac{x+3}{2} \\\\ &= \\frac{2(2x-2) + 5(x+3)}{10} \\\\ &= \\frac{4x-4 + 5x+15}{10} \\\\ &= \\frac{9x+11}{10} \\end{aligned}" },
  { question: "$\\frac{3(x+2)}{4} - \\frac{2(x-1)}{3}$", choices: ["$\\frac{x+22}{12}$", "$\\frac{x+8}{1}$", "$\\frac{17x+14}{12}$", "$\\frac{x+14}{12}$"], answer: "$\\frac{x+22}{12}$", process: "\\begin{aligned} & \\frac{3(x+2)}{4} - \\frac{2(x-1)}{3} \\\\ &= \\frac{3x+6}{4} - \\frac{2x-2}{3} \\\\ &= \\frac{3(3x+6) - 4(2x-2)}{12} \\\\ &= \\frac{9x+18 - 8x+8}{12} \\\\ &= \\frac{x+22}{12} \\end{aligned}" },
  { question: "$\\frac{x-6}{2} + \\frac{x+4}{4}$", choices: ["$\\frac{3x-8}{4}$", "$\\frac{2x-2}{6}$", "$\\frac{3x-2}{4}$", "$\\frac{x-10}{4}$"], answer: "$\\frac{3x-8}{4}$", process: "\\begin{aligned} & \\frac{x-6}{2} + \\frac{x+4}{4} \\\\ &= \\frac{2(x-6) + (x+4)}{4} \\\\ &= \\frac{2x-12 + x+4}{4} \\\\ &= \\frac{3x-8}{4} \\end{aligned}" },
  { question: "$\\frac{4x+1}{3} - \\frac{x-2}{6}$", choices: ["$\\frac{7x+4}{6}$", "$\\frac{3x+3}{ -3}$", "$\\frac{7x}{6}$", "$\\frac{9x}{6}$"], answer: "$\\frac{7x+4}{6}$", process: "\\begin{aligned} & \\frac{4x+1}{3} - \\frac{x-2}{6} \\\\ &= \\frac{2(4x+1) - (x-2)}{6} \\\\ &= \\frac{8x+2 - x+2}{6} \\\\ &= \\frac{7x+4}{6} \\end{aligned}" },
  { question: "$\\frac{1}{2}(x+3) + \\frac{1}{4}(x-1)$", choices: ["$\\frac{3x+5}{4}$", "$\\frac{2x+2}{6}$", "$\\frac{3x+7}{4}$", "$\\frac{x+4}{4}$"], answer: "$\\frac{3x+5}{4}$", process: "\\begin{aligned} & \\frac{1}{2}(x+3) + \\frac{1}{4}(x-1) \\\\ &= \\frac{x+3}{2} + \\frac{x-1}{4} \\\\ &= \\frac{2(x+3) + (x-1)}{4} \\\\ &= \\frac{2x+6+x-1}{4} \\\\ &= \\frac{3x+5}{4} \\end{aligned}" },
  { question: "$\\frac{2}{3}(x-1) - \\frac{1}{6}(x+4)$", choices: ["$\\frac{3x-8}{6}$", "$\\frac{x-5}{ -3}$", "$\\frac{3x}{6}$", "$\\frac{5x}{6}$"], answer: "$\\frac{3x-8}{6}$", process: "\\begin{aligned} & \\frac{2}{3}(x-1) - \\frac{1}{6}(x+4) \\\\ &= \\frac{2x-2}{3} - \\frac{x+4}{6} \\\\ &= \\frac{2(2x-2) - (x+4)}{6} \\\\ &= \\frac{4x-4 - x-4}{6} \\\\ &= \\frac{3x-8}{6} \\end{aligned}" },
  { question: "$3x + \\frac{1-x}{4}$", choices: ["$\\frac{11x+1}{4}$", "$\\frac{2x+1}{4}$", "$11x+1$", "$\\frac{13x-1}{4}$"], answer: "$\\frac{11x+1}{4}$", process: "\\begin{aligned} & 3x + \\frac{1-x}{4} \\\\ &= \\frac{12x}{4} + \\frac{1-x}{4} \\\\ &= \\frac{12x+1-x}{4} \\\\ &= \\frac{11x+1}{4} \\end{aligned}" },
  { question: "$\\frac{2x+5}{3} - x$", choices: ["$\\frac{-x+5}{3}$", "$\\frac{x+5}{3}$", "$-x+5$", "$\\frac{5x+5}{3}$"], answer: "$\\frac{-x+5}{3}$", process: "\\begin{aligned} & \\frac{2x+5}{3} - x \\\\ &= \\frac{2x+5}{3} - \\frac{3x}{3} \\\\ &= \\frac{2x+5-3x}{3} \\\\ &= \\frac{-x+5}{3} \\end{aligned}" },
  { question: "$\\frac{x-1}{5} + \\frac{x+1}{10}$", choices: ["$\\frac{3x-1}{10}$", "$\\frac{2x}{15}$", "$\\frac{3x+1}{10}$", "$\\frac{x-3}{10}$"], answer: "$\\frac{3x-1}{10}$", process: "\\begin{aligned} & \\frac{x-1}{5} + \\frac{x+1}{10} \\\\ &= \\frac{2(x-1) + (x+1)}{10} \\\\ &= \\frac{2x-2+x+1}{10} \\\\ &= \\frac{3x-1}{10} \\end{aligned}" },
  { question: "$\\frac{3x-2}{8} - \\frac{x+1}{4}$", choices: ["$\\frac{x-4}{8}$", "$\\frac{2x-3}{4}$", "$\\frac{x}{8}$", "$\\frac{5x}{8}$"], answer: "$\\frac{x-4}{8}$", process: "\\begin{aligned} & \\frac{3x-2}{8} - \\frac{x+1}{4} \\\\ &= \\frac{(3x-2) - 2(x+1)}{8} \\\\ &= \\frac{3x-2 - 2x-2}{8} \\\\ &= \\frac{x-4}{8} \\end{aligned}" },
  { question: "$\\frac{1}{3}(2x+1) + \\frac{1}{2}(x-2)$", choices: ["$\\frac{7x-4}{6}$", "$\\frac{3x-1}{5}$", "$\\frac{7x-8}{6}$", "$\\frac{5x-4}{6}$"], answer: "$\\frac{7x-4}{6}$", process: "\\begin{aligned} & \\frac{1}{3}(2x+1) + \\frac{1}{2}(x-2) \\\\ &= \\frac{2x+1}{3} + \\frac{x-2}{2} \\\\ &= \\frac{2(2x+1) + 3(x-2)}{6} \\\\ &= \\frac{4x+2 + 3x-6}{6} \\\\ &= \\frac{7x-4}{6} \\end{aligned}" },
  { question: "$\\frac{3}{4}(x-2) - \\frac{1}{2}(x+1)$", choices: ["$\\frac{x-8}{4}$", "$\\frac{2x-3}{2}$", "$\\frac{x-4}{4}$", "$\\frac{5x-8}{4}$"], answer: "$\\frac{x-8}{4}$", process: "\\begin{aligned} & \\frac{3}{4}(x-2) - \\frac{1}{2}(x+1) \\\\ &= \\frac{3x-6}{4} - \\frac{x+1}{2} \\\\ &= \\frac{3x-6 - 2(x+1)}{4} \\\\ &= \\frac{3x-6 - 2x-2}{4} \\\\ &= \\frac{x-8}{4} \\end{aligned}" },
  { question: "$\\frac{x+5}{6} + \\frac{x-2}{3}$", choices: ["$\\frac{3x+1}{6}$", "$\\frac{2x+3}{9}$", "$\\frac{3x+9}{6}$", "$\\frac{-x+7}{6}$"], answer: "$\\frac{3x+1}{6}$", process: "\\begin{aligned} & \\frac{x+5}{6} + \\frac{x-2}{3} \\\\ &= \\frac{(x+5) + 2(x-2)}{6} \\\\ &= \\frac{x+5+2x-4}{6} \\\\ &= \\frac{3x+1}{6} \\end{aligned}" },
  { question: "$\\frac{5x+1}{4} - \\frac{x-3}{2}$", choices: ["$\\frac{3x+7}{4}$", "$\\frac{4x+4}{2}$", "$\\frac{3x-5}{4}$", "$\\frac{7x-5}{4}$"], answer: "$\\frac{3x+7}{4}$", process: "\\begin{aligned} & \\frac{5x+1}{4} - \\frac{x-3}{2} \\\\ &= \\frac{(5x+1) - 2(x-3)}{4} \\\\ &= \\frac{5x+1 - 2x+6}{4} \\\\ &= \\frac{3x+7}{4} \\end{aligned}" },
  { question: "$-x + \\frac{2x+1}{3}$", choices: ["$\\frac{-x+1}{3}$", "$\\frac{x+1}{3}$", "$-x+1$", "$\\frac{-5x+1}{3}$"], answer: "$\\frac{-x+1}{3}$", process: "\\begin{aligned} & -x + \\frac{2x+1}{3} \\\\ &= \\frac{-3x}{3} + \\frac{2x+1}{3} \\\\ &= \\frac{-3x+2x+1}{3} \\\\ &= \\frac{-x+1}{3} \\end{aligned}" },
  // --- 【2番目が正解の問題】 (25問) ---
  { question: "$\\frac{x+2}{3} + \\frac{x-2}{4}$", choices: ["$\\frac{7x+14}{12}$", "$\\frac{7x+2}{12}$", "$\\frac{2x}{7}$", "$x$"], answer: "$\\frac{7x+2}{12}$", process: "\\begin{aligned} & \\frac{x+2}{3} + \\frac{x-2}{4} \\\\ &= \\frac{4(x+2) + 3(x-2)}{12} \\\\ &= \\frac{4x+8 + 3x-6}{12} \\\\ &= \\frac{7x+2}{12} \\end{aligned}" },
  { question: "$\\frac{3x-1}{2} - \\frac{x+1}{5}$", choices: ["$\\frac{2x-2}{-3}$", "$\\frac{13x-7}{10}$", "$\\frac{13x-3}{10}$", "$\\frac{17x-7}{10}$"], answer: "$\\frac{13x-7}{10}$", process: "\\begin{aligned} & \\frac{3x-1}{2} - \\frac{x+1}{5} \\\\ &= \\frac{5(3x-1) - 2(x+1)}{10} \\\\ &= \\frac{15x-5 - 2x-2}{10} \\\\ &= \\frac{13x-7}{10} \\end{aligned}" },
  { question: "$3x + \\frac{x-1}{4}$", choices: ["$\\frac{4x-1}{4}$", "$\\frac{13x-1}{4}$", "$13x-1$", "$\\frac{11x+1}{4}$"], answer: "$\\frac{13x-1}{4}$", process: "\\begin{aligned} & 3x + \\frac{x-1}{4} \\\\ &= \\frac{12x}{4} + \\frac{x-1}{4} \\\\ &= \\frac{12x+x-1}{4} \\\\ &= \\frac{13x-1}{4} \\end{aligned}" },
  { question: "$\\frac{4x+3}{2} - \\frac{x-2}{3}$", choices: ["$\\frac{3x+5}{ -1}$", "$\\frac{10x+13}{6}$", "$\\frac{10x+5}{6}$", "$\\frac{14x+13}{6}$"], answer: "$\\frac{10x+13}{6}$", process: "\\begin{aligned} & \\frac{4x+3}{2} - \\frac{x-2}{3} \\\\ &= \\frac{3(4x+3) - 2(x-2)}{6} \\\\ &= \\frac{12x+9 - 2x+4}{6} \\\\ &= \\frac{10x+13}{6} \\end{aligned}" },
  { question: "$\\frac{x}{4} + \\frac{3x+1}{8}$", choices: ["$\\frac{4x+1}{12}$", "$\\frac{5x+1}{8}$", "$\\frac{5x+1}{32}$", "$\\frac{2x+1}{8}$"], answer: "$\\frac{5x+1}{8}$", process: "\\begin{aligned} & \\frac{x}{4} + \\frac{3x+1}{8} \\\\ &= \\frac{2x}{8} + \\frac{3x+1}{8} \\\\ &= \\frac{2x+3x+1}{8} \\\\ &= \\frac{5x+1}{8} \\end{aligned}" },
  { question: "$x - \\frac{2x+1}{5}$", choices: ["$\\frac{-x-1}{5}$", "$\\frac{3x-1}{5}$", "$3x-1$", "$\\frac{7x+1}{5}$"], answer: "$\\frac{3x-1}{5}$", process: "\\begin{aligned} & x - \\frac{2x+1}{5} \\\\ &= \\frac{5x}{5} - \\frac{2x+1}{5} \\\\ &= \\frac{5x - (2x+1)}{5} \\\\ &= \\frac{5x-2x-1}{5} \\\\ &= \\frac{3x-1}{5} \\end{aligned}" },
  { question: "$\\frac{-x+3}{6} + \\frac{x-1}{2}$", choices: ["$\\frac{0}{8}$", "$\\frac{2x}{6}$", "$\\frac{2x+3}{6}$", "$\\frac{-4x+6}{6}$"], answer: "$\\frac{2x}{6}$", process: "\\begin{aligned} & \\frac{-x+3}{6} + \\frac{x-1}{2} \\\\ &= \\frac{-x+3 + 3(x-1)}{6} \\\\ &= \\frac{-x+3 + 3x-3}{6} \\\\ &= \\frac{2x}{6} \\end{aligned}" },
  { question: "$\\frac{2x-1}{4} - \\frac{4x+1}{2}$", choices: ["$\\frac{-2x-2}{2}$", "$\\frac{-6x-3}{4}$", "$\\frac{-6x+1}{4}$", "$\\frac{10x+3}{4}$"], answer: "$\\frac{-6x-3}{4}$", process: "\\begin{aligned} & \\frac{2x-1}{4} - \\frac{4x+1}{2} \\\\ &= \\frac{2x-1 - 2(4x+1)}{4} \\\\ &= \\frac{2x-1 - 8x-2}{4} \\\\ &= \\frac{-6x-3}{4} \\end{aligned}" },
  { question: "$\\frac{3x-5}{3} + 2x$", choices: ["$\\frac{5x-5}{3}$", "$\\frac{9x-5}{3}$", "$9x-5$", "$\\frac{3x-3}{3}$"], answer: "$\\frac{9x-5}{3}$", process: "\\begin{aligned} & \\frac{3x-5}{3} + 2x \\\\ &= \\frac{3x-5}{3} + \\frac{6x}{3} \\\\ &= \\frac{3x-5+6x}{3} \\\\ &= \\frac{9x-5}{3} \\end{aligned}" },
  { question: "$\\frac{x+4}{2} - 3x$", choices: ["$\\frac{-2x+4}{2}$", "$\\frac{-5x+4}{2}$", "$-5x+4$", "$\\frac{7x+4}{2}$"], answer: "$\\frac{-5x+4}{2}$", process: "\\begin{aligned} & \\frac{x+4}{2} - 3x \\\\ &= \\frac{x+4}{2} - \\frac{6x}{2} \\\\ &= \\frac{x+4-6x}{2} \\\\ &= \\frac{-5x+4}{2} \\end{aligned}" },
  { question: "$\\frac{3(x-2)}{2} + \\frac{x+1}{4}$", choices: ["$\\frac{4x-1}{6}$", "$\\frac{7x-11}{4}$", "$\\frac{7x-5}{4}$", "$\\frac{5x-11}{4}$"], answer: "$\\frac{7x-11}{4}$", process: "\\begin{aligned} & \\frac{3(x-2)}{2} + \\frac{x+1}{4} \\\\ &= \\frac{3x-6}{2} + \\frac{x+1}{4} \\\\ &= \\frac{2(3x-6) + (x+1)}{4} \\\\ &= \\frac{6x-12+x+1}{4} \\\\ &= \\frac{7x-11}{4} \\end{aligned}" },
  { question: "$\\frac{2(x+1)}{5} - \\frac{3(x-1)}{2}$", choices: ["$\\frac{-x+4}{3}$", "$\\frac{-11x+17}{10}$", "$\\frac{-11x-13}{10}$", "$\\frac{19x+17}{10}$"], answer: "$\\frac{-11x+17}{10}$", process: "\\begin{aligned} & \\frac{2(x+1)}{5} - \\frac{3(x-1)}{2} \\\\ &= \\frac{2x+2}{5} - \\frac{3x-3}{2} \\\\ &= \\frac{2(2x+2) - 5(3x-3)}{10} \\\\ &= \\frac{4x+4 - 15x+15}{10} \\\\ &= \\frac{-11x+17}{10} \\end{aligned}" },
  { question: "$\\frac{x-3}{3} + \\frac{x+5}{6}$", choices: ["$\\frac{2x+2}{9}$", "$\\frac{3x-1}{6}$", "$\\frac{3x+7}{6}$", "$\\frac{-x-11}{6}$"], answer: "$\\frac{3x-1}{6}$", process: "\\begin{aligned} & \\frac{x-3}{3} + \\frac{x+5}{6} \\\\ &= \\frac{2(x-3) + (x+5)}{6} \\\\ &= \\frac{2x-6+x+5}{6} \\\\ &= \\frac{3x-1}{6} \\end{aligned}" },
  { question: "$\\frac{5x+2}{4} - \\frac{x-1}{8}$", choices: ["$\\frac{4x+3}{ -4}$", "$\\frac{9x+5}{8}$", "$\\frac{9x+3}{8}$", "$\\frac{11x+3}{8}$"], answer: "$\\frac{9x+5}{8}$", process: "\\begin{aligned} & \\frac{5x+2}{4} - \\frac{x-1}{8} \\\\ &= \\frac{2(5x+2) - (x-1)}{8} \\\\ &= \\frac{10x+4 - x+1}{8} \\\\ &= \\frac{9x+5}{8} \\end{aligned}" },
  { question: "$\\frac{1}{2}(x+1) + \\frac{1}{3}(x-1)$", choices: ["$\\frac{2x}{5}$", "$\\frac{5x+1}{6}$", "$\\frac{5x+5}{6}$", "$x$"], answer: "$\\frac{5x+1}{6}$", process: "\\begin{aligned} & \\frac{1}{2}(x+1) + \\frac{1}{3}(x-1) \\\\ &= \\frac{x+1}{2} + \\frac{x-1}{3} \\\\ &= \\frac{3(x+1) + 2(x-1)}{6} \\\\ &= \\frac{3x+3 + 2x-2}{6} \\\\ &= \\frac{5x+1}{6} \\end{aligned}" },
  { question: "$\\frac{1}{4}(x-3) - \\frac{1}{2}(x+1)$", choices: ["$\\frac{-x-1}{2}$", "$\\frac{-x-5}{4}$", "$\\frac{-x-1}{4}$", "$\\frac{3x-5}{4}$"], answer: "$\\frac{-x-5}{4}$", process: "\\begin{aligned} & \\frac{1}{4}(x-3) - \\frac{1}{2}(x+1) \\\\ &= \\frac{x-3}{4} - \\frac{x+1}{2} \\\\ &= \\frac{x-3 - 2(x+1)}{4} \\\\ &= \\frac{x-3 - 2x-2}{4} \\\\ &= \\frac{-x-5}{4} \\end{aligned}" },
  { question: "$4x + \\frac{2-x}{3}$", choices: ["$\\frac{3x+2}{3}$", "$\\frac{11x+2}{3}$", "$11x+2$", "$\\frac{13x-2}{3}$"], answer: "$\\frac{11x+2}{3}$", process: "\\begin{aligned} & 4x + \\frac{2-x}{3} \\\\ &= \\frac{12x}{3} + \\frac{2-x}{3} \\\\ &= \\frac{12x+2-x}{3} \\\\ &= \\frac{11x+2}{3} \\end{aligned}" },
  { question: "$\\frac{3x+4}{2} - 2x$", choices: ["$\\frac{x+4}{2}$", "$\\frac{-x+4}{2}$", "$-x+4$", "$\\frac{7x+4}{2}$"], answer: "$\\frac{-x+4}{2}$", process: "\\begin{aligned} & \\frac{3x+4}{2} - 2x \\\\ &= \\frac{3x+4}{2} - \\frac{4x}{2} \\\\ &= \\frac{3x+4-4x}{2} \\\\ &= \\frac{-x+4}{2} \\end{aligned}" },
  { question: "$\\frac{x-2}{6} + \\frac{x+3}{3}$", choices: ["$\\frac{2x+1}{9}$", "$\\frac{3x+4}{6}$", "$\\frac{3x+8}{6}$", "$\\frac{-x-5}{6}$"], answer: "$\\frac{3x+4}{6}$", process: "\\begin{aligned} & \\frac{x-2}{6} + \\frac{x+3}{3} \\\\ &= \\frac{(x-2) + 2(x+3)}{6} \\\\ &= \\frac{x-2+2x+6}{6} \\\\ &= \\frac{3x+4}{6} \\end{aligned}" },
  { question: "$\\frac{4x-3}{10} - \\frac{x+1}{5}$", choices: ["$\\frac{3x-4}{5}$", "$\\frac{2x-5}{10}$", "$\\frac{2x-1}{10}$", "$\\frac{6x-1}{10}$"], answer: "$\\frac{2x-5}{10}$", process: "\\begin{aligned} & \\frac{4x-3}{10} - \\frac{x+1}{5} \\\\ &= \\frac{(4x-3) - 2(x+1)}{10} \\\\ &= \\frac{4x-3 - 2x-2}{10} \\\\ &= \\frac{2x-5}{10} \\end{aligned}" },
  { question: "$\\frac{1}{5}(3x+1) + \\frac{1}{2}(x-1)$", choices: ["$\\frac{4x}{7}$", "$\\frac{11x-3}{10}$", "$\\frac{11x-7}{10}$", "$\\frac{7x-3}{10}$"], answer: "$\\frac{11x-3}{10}$", process: "\\begin{aligned} & \\frac{1}{5}(3x+1) + \\frac{1}{2}(x-1) \\\\ &= \\frac{3x+1}{5} + \\frac{x-1}{2} \\\\ &= \\frac{2(3x+1) + 5(x-1)}{10} \\\\ &= \\frac{6x+2 + 5x-5}{10} \\\\ &= \\frac{11x-3}{10} \\end{aligned}" },
  { question: "$\\frac{2}{5}(x-3) - \\frac{1}{10}(x+2)$", choices: ["$\\frac{x-5}{-5}$", "$\\frac{3x-14}{10}$", "$\\frac{3x-10}{10}$", "$\\frac{5x-14}{10}$"], answer: "$\\frac{3x-14}{10}$", process: "\\begin{aligned} & \\frac{2}{5}(x-3) - \\frac{1}{10}(x+2) \\\\ &= \\frac{2x-6}{5} - \\frac{x+2}{10} \\\\ &= \\frac{2(2x-6) - (x+2)}{10} \\\\ &= \\frac{4x-12 - x-2}{10} \\\\ &= \\frac{3x-14}{10} \\end{aligned}" },
  { question: "$\\frac{x+6}{4} + \\frac{x-1}{2}$", choices: ["$\\frac{2x+5}{6}$", "$\\frac{3x+4}{4}$", "$\\frac{3x+8}{4}$", "$\\frac{-x+7}{4}$"], answer: "$\\frac{3x+4}{4}$", process: "\\begin{aligned} & \\frac{x+6}{4} + \\frac{x-1}{2} \\\\ &= \\frac{(x+6) + 2(x-1)}{4} \\\\ &= \\frac{x+6+2x-2}{4} \\\\ &= \\frac{3x+4}{4} \\end{aligned}" },
  { question: "$\\frac{6x+1}{5} - \\frac{x-2}{10}$", choices: ["$\\frac{5x+3}{-5}$", "$\\frac{11x+4}{10}$", "$\\frac{11x}{10}$", "$\\frac{13x}{10}$"], answer: "$\\frac{11x+4}{10}$", process: "\\begin{aligned} & \\frac{6x+1}{5} - \\frac{x-2}{10} \\\\ &= \\frac{2(6x+1) - (x-2)}{10} \\\\ &= \\frac{12x+2 - x+2}{10} \\\\ &= \\frac{11x+4}{10} \\end{aligned}" },
  { question: "$-2x + \\frac{x+3}{4}$", choices: ["$\\frac{-x+3}{4}$", "$\\frac{-7x+3}{4}$", "$-7x+3$", "$\\frac{-9x+3}{4}$"], answer: "$\\frac{-7x+3}{4}$", process: "\\begin{aligned} & -2x + \\frac{x+3}{4} \\\\ &= \\frac{-8x}{4} + \\frac{x+3}{4} \\\\ &= \\frac{-8x+x+3}{4} \\\\ &= \\frac{-7x+3}{4} \\end{aligned}" },
  // --- 【3番目が正解の問題】 (25問) ---
  { question: "$\\frac{x+3}{4} + \\frac{x-1}{2}$", choices: ["$\\frac{2x+2}{6}$", "$\\frac{3x+5}{4}$", "$\\frac{3x+1}{4}$", "$\\frac{-x+5}{4}$"], answer: "$\\frac{3x+1}{4}$", process: "\\begin{aligned} & \\frac{x+3}{4} + \\frac{x-1}{2} \\\\ &= \\frac{(x+3) + 2(x-1)}{4} \\\\ &= \\frac{x+3+2x-2}{4} \\\\ &= \\frac{3x+1}{4} \\end{aligned}" },
  { question: "$\\frac{4x-1}{3} - \\frac{x+1}{6}$", choices: ["$\\frac{3x-2}{-3}$", "$\\frac{7x-1}{6}$", "$\\frac{7x-3}{6}$", "$\\frac{9x-3}{6}$"], answer: "$\\frac{7x-3}{6}$", process: "\\begin{aligned} & \\frac{4x-1}{3} - \\frac{x+1}{6} \\\\ &= \\frac{2(4x-1) - (x+1)}{6} \\\\ &= \\frac{8x-2 - x-1}{6} \\\\ &= \\frac{7x-3}{6} \\end{aligned}" },
  { question: "$2x + \\frac{3-x}{5}$", choices: ["$\\frac{x+3}{5}$", "$\\frac{11x+3}{5}$", "$\\frac{9x+3}{5}$", "$9x+3$"], answer: "$\\frac{9x+3}{5}$", process: "\\begin{aligned} & 2x + \\frac{3-x}{5} \\\\ &= \\frac{10x}{5} + \\frac{3-x}{5} \\\\ &= \\frac{10x+3-x}{5} \\\\ &= \\frac{9x+3}{5} \\end{aligned}" },
  { question: "$\\frac{5x+1}{2} - 3x$", choices: ["$\\frac{2x+1}{2}$", "$\\frac{-x-1}{2}$", "$\\frac{-x+1}{2}$", "$-x+1$"], answer: "$\\frac{-x+1}{2}$", process: "\\begin{aligned} & \\frac{5x+1}{2} - 3x \\\\ &= \\frac{5x+1}{2} - \\frac{6x}{2} \\\\ &= \\frac{5x+1-6x}{2} \\\\ &= \\frac{-x+1}{2} \\end{aligned}" },
  { question: "$\\frac{x-4}{2} + \\frac{x+2}{8}$", choices: ["$\\frac{2x-2}{10}$", "$\\frac{5x-10}{8}$", "$\\frac{5x-14}{8}$", "$\\frac{3x-6}{8}$"], answer: "$\\frac{5x-14}{8}$", process: "\\begin{aligned} & \\frac{x-4}{2} + \\frac{x+2}{8} \\\\ &= \\frac{4(x-4) + (x+2)}{8} \\\\ &= \\frac{4x-16+x+2}{8} \\\\ &= \\frac{5x-14}{8} \\end{aligned}" },
  { question: "$\\frac{2x-5}{9} - \\frac{x+1}{3}$", choices: ["$\\frac{x-6}{6}$", "$\\frac{-x-2}{9}$", "$\\frac{-x-8}{9}$", "$\\frac{5x-8}{9}$"], answer: "$\\frac{-x-8}{9}$", process: "\\begin{aligned} & \\frac{2x-5}{9} - \\frac{x+1}{3} \\\\ &= \\frac{(2x-5) - 3(x+1)}{9} \\\\ &= \\frac{2x-5 - 3x-3}{9} \\\\ &= \\frac{-x-8}{9} \\end{aligned}" },
  { question: "$\\frac{1}{3}(x+4) + \\frac{1}{6}(x-2)$", choices: ["$\\frac{2x+2}{9}$", "$\\frac{3x+2}{6}$", "$\\frac{3x+6}{6}$", "$\\frac{x+10}{6}$"], answer: "$\\frac{3x+6}{6}$", process: "\\begin{aligned} & \\frac{1}{3}(x+4) + \\frac{1}{6}(x-2) \\\\ &= \\frac{x+4}{3} + \\frac{x-2}{6} \\\\ &= \\frac{2(x+4) + (x-2)}{6} \\\\ &= \\frac{2x+8+x-2}{6} \\\\ &= \\frac{3x+6}{6} \\end{aligned}" },
  { question: "$\\frac{3}{2}(x-1) - \\frac{1}{4}(x+2)$", choices: ["$\\frac{2x-3}{-2}$", "$\\frac{5x-4}{4}$", "$\\frac{5x-8}{4}$", "$\\frac{7x-4}{4}$"], answer: "$\\frac{5x-8}{4}$", process: "\\begin{aligned} & \\frac{3}{2}(x-1) - \\frac{1}{4}(x+2) \\\\ &= \\frac{3x-3}{2} - \\frac{x+2}{4} \\\\ &= \\frac{2(3x-3) - (x+2)}{4} \\\\ &= \\frac{6x-6 - x-2}{4} \\\\ &= \\frac{5x-8}{4} \\end{aligned}" },
  { question: "$\\frac{x+1}{2} - \\frac{1-x}{4}$", choices: ["$\\frac{2x}{ -2}$", "$\\frac{3x+3}{4}$", "$\\frac{3x+1}{4}$", "$\\frac{x+3}{4}$"], answer: "$\\frac{3x+1}{4}$", process: "\\begin{aligned} & \\frac{x+1}{2} - \\frac{1-x}{4} \\\\ &= \\frac{2(x+1) - (1-x)}{4} \\\\ &= \\frac{2x+2 - 1+x}{4} \\\\ &= \\frac{3x+1}{4} \\end{aligned}" },
  { question: "$x - \\frac{3x-1}{2}$", choices: ["$\\frac{-2x+1}{2}$", "$\\frac{-x-1}{2}$", "$\\frac{-x+1}{2}$", "$-x+1$"], answer: "$\\frac{-x+1}{2}$", process: "\\begin{aligned} & x - \\frac{3x-1}{2} \\\\ &= \\frac{2x}{2} - \\frac{3x-1}{2} \\\\ &= \\frac{2x-(3x-1)}{2} \\\\ &= \\frac{2x-3x+1}{2} \\\\ &= \\frac{-x+1}{2} \\end{aligned}" },
  { question: "$\\frac{x+2}{5} + \\frac{2x-1}{10}$", choices: ["$\\frac{3x+1}{15}$", "$\\frac{4x+5}{10}$", "$\\frac{4x+3}{10}$", "$\\frac{2x+1}{10}$"], answer: "$\\frac{4x+3}{10}$", process: "\\begin{aligned} & \\frac{x+2}{5} + \\frac{2x-1}{10} \\\\ &= \\frac{2(x+2) + (2x-1)}{10} \\\\ &= \\frac{2x+4+2x-1}{10} \\\\ &= \\frac{4x+3}{10} \\end{aligned}" },
  { question: "$\\frac{5x-3}{6} - \\frac{x+2}{2}$", choices: ["$\\frac{4x-5}{4}$", "$\\frac{2x-5}{6}$", "$\\frac{2x-9}{6}$", "$\\frac{8x-9}{6}$"], answer: "$\\frac{2x-9}{6}$", process: "\\begin{aligned} & \\frac{5x-3}{6} - \\frac{x+2}{2} \\\\ &= \\frac{(5x-3) - 3(x+2)}{6} \\\\ &= \\frac{5x-3 - 3x-6}{6} \\\\ &= \\frac{2x-9}{6} \\end{aligned}" },
  { question: "$\\frac{2}{3}(x+1) + \\frac{1}{4}(x-2)$", choices: ["$\\frac{3x-1}{7}$", "$\\frac{11x-2}{12}$", "$\\frac{11x+2}{12}$", "$\\frac{5x+2}{12}$"], answer: "$\\frac{11x+2}{12}$", process: "\\begin{aligned} & \\frac{2}{3}(x+1) + \\frac{1}{4}(x-2) \\\\ &= \\frac{2x+2}{3} + \\frac{x-2}{4} \\\\ &= \\frac{4(2x+2) + 3(x-2)}{12} \\\\ &= \\frac{8x+8 + 3x-6}{12} \\\\ &= \\frac{11x+2}{12} \\end{aligned}" },
  { question: "$\\frac{1}{2}(3x-1) - \\frac{2}{5}(x+1)$", choices: ["$\\frac{x-2}{ -3}$", "$\\frac{11x-7}{10}$", "$\\frac{11x-9}{10}$", "$\\frac{19x-9}{10}$"], answer: "$\\frac{11x-9}{10}$", process: "\\begin{aligned} & \\frac{1}{2}(3x-1) - \\frac{2}{5}(x+1) \\\\ &= \\frac{3x-1}{2} - \\frac{2x+2}{5} \\\\ &= \\frac{5(3x-1) - 2(2x+2)}{10} \\\\ &= \\frac{15x-5 - 4x-4}{10} \\\\ &= \\frac{11x-9}{10} \\end{aligned}" },
  { question: "$5x + \\frac{1-2x}{3}$", choices: ["$\\frac{3x+1}{3}$", "$\\frac{17x+1}{3}$", "$\\frac{13x+1}{3}$", "$13x+1$"], answer: "$\\frac{13x+1}{3}$", process: "\\begin{aligned} & 5x + \\frac{1-2x}{3} \\\\ &= \\frac{15x}{3} + \\frac{1-2x}{3} \\\\ &= \\frac{15x+1-2x}{3} \\\\ &= \\frac{13x+1}{3} \\end{aligned}" },
  { question: "$\\frac{4x+1}{4} - x$", choices: ["$\\frac{3x+1}{4}$", "$\\frac{5x+1}{4}$", "$\\frac{1}{4}$", "$1$"], answer: "$\\frac{1}{4}$", process: "\\begin{aligned} & \\frac{4x+1}{4} - x \\\\ &= \\frac{4x+1}{4} - \\frac{4x}{4} \\\\ &= \\frac{4x+1-4x}{4} \\\\ &= \\frac{1}{4} \\end{aligned}" },
  { question: "$\\frac{x-5}{4} + \\frac{x+1}{8}$", choices: ["$\\frac{2x-4}{12}$", "$\\frac{3x-11}{8}$", "$\\frac{3x-9}{8}$", "$\\frac{x-9}{8}$"], answer: "$\\frac{3x-9}{8}$", process: "\\begin{aligned} & \\frac{x-5}{4} + \\frac{x+1}{8} \\\\ &= \\frac{2(x-5) + (x+1)}{8} \\\\ &= \\frac{2x-10+x+1}{8} \\\\ &= \\frac{3x-9}{8} \\end{aligned}" },
  { question: "$\\frac{6x-1}{6} - \\frac{x+2}{3}$", choices: ["$\\frac{5x-3}{3}$", "$\\frac{4x-3}{6}$", "$\\frac{4x-5}{6}$", "$\\frac{8x-5}{6}$"], answer: "$\\frac{4x-5}{6}$", process: "\\begin{aligned} & \\frac{6x-1}{6} - \\frac{x+2}{3} \\\\ &= \\frac{(6x-1) - 2(x+2)}{6} \\\\ &= \\frac{6x-1 - 2x-4}{6} \\\\ &= \\frac{4x-5}{6} \\end{aligned}" },
  { question: "$\\frac{1}{4}(x+2) + \\frac{1}{8}(x-4)$", choices: ["$\\frac{2x-2}{12}$", "$\\frac{3x+8}{8}$", "$\\frac{3x}{8}$", "$\\frac{x}{8}$"], answer: "$\\frac{3x}{8}$", process: "\\begin{aligned} & \\frac{1}{4}(x+2) + \\frac{1}{8}(x-4) \\\\ &= \\frac{x+2}{4} + \\frac{x-4}{8} \\\\ &= \\frac{2(x+2) + (x-4)}{8} \\\\ &= \\frac{2x+4+x-4}{8} \\\\ &= \\frac{3x}{8} \\end{aligned}" },
  { question: "$\\frac{5}{6}(x-1) - \\frac{1}{3}(x+1)$", choices: ["$\\frac{4x-2}{3}$", "$\\frac{3x-5}{6}$", "$\\frac{3x-7}{6}$", "$\\frac{7x-7}{6}$"], answer: "$\\frac{3x-7}{6}$", process: "\\begin{aligned} & \\frac{5}{6}(x-1) - \\frac{1}{3}(x+1) \\\\ &= \\frac{5x-5}{6} - \\frac{x+1}{3} \\\\ &= \\frac{5x-5 - 2(x+1)}{6} \\\\ &= \\frac{5x-5 - 2x-2}{6} \\\\ &= \\frac{3x-7}{6} \\end{aligned}" },
  { question: "$\\frac{x+8}{2} + \\frac{x-3}{4}$", choices: ["$\\frac{2x+5}{6}$", "$\\frac{3x+5}{4}$", "$\\frac{3x+13}{4}$", "$\\frac{x+11}{4}$"], answer: "$\\frac{3x+13}{4}$", process: "\\begin{aligned} & \\frac{x+8}{2} + \\frac{x-3}{4} \\\\ &= \\frac{2(x+8) + (x-3)}{4} \\\\ &= \\frac{2x+16+x-3}{4} \\\\ &= \\frac{3x+13}{4} \\end{aligned}" },
  { question: "$\\frac{3x+1}{9} - \\frac{x-1}{3}$", choices: ["$\\frac{2x}{6}$", "$\\frac{4}{9}$", "$\\frac{4}{9}$", "$\\frac{6x+4}{9}$"], answer: "$\\frac{4}{9}$", process: "\\begin{aligned} & \\frac{3x+1}{9} - \\frac{x-1}{3} \\\\ &= \\frac{(3x+1) - 3(x-1)}{9} \\\\ &= \\frac{3x+1 - 3x+3}{9} \\\\ &= \\frac{4}{9} \\end{aligned}" }, // Corrected duplicate
  { question: "$-3x + \\frac{x+6}{2}$", choices: ["$\\frac{-2x+6}{2}$", "$\\frac{-4x+6}{2}$", "$\\frac{-5x+6}{2}$", "$-5x+6$"], answer: "$\\frac{-5x+6}{2}$", process: "\\begin{aligned} & -3x + \\frac{x+6}{2} \\\\ &= \\frac{-6x}{2} + \\frac{x+6}{2} \\\\ &= \\frac{-6x+x+6}{2} \\\\ &= \\frac{-5x+6}{2} \\end{aligned}" },
  { question: "$\\frac{7x+2}{5} - x$", choices: ["$\\frac{6x+2}{5}$", "$\\frac{8x+2}{5}$", "$\\frac{2x+2}{5}$", "$2x+2$"], answer: "$\\frac{2x+2}{5}$", process: "\\begin{aligned} & \\frac{7x+2}{5} - x \\\\ &= \\frac{7x+2}{5} - \\frac{5x}{5} \\\\ &= \\frac{7x+2-5x}{5} \\\\ &= \\frac{2x+2}{5} \\end{aligned}" },
  { question: "$\\frac{1}{6}(x-4) + \\frac{1}{3}(x+1)$", choices: ["$\\frac{2x-3}{9}$", "$\\frac{3x+2}{6}$", "$\\frac{3x-2}{6}$", "$\\frac{x-2}{6}$"], answer: "$\\frac{3x-2}{6}$", process: "\\begin{aligned} & \\frac{1}{6}(x-4) + \\frac{1}{3}(x+1) \\\\ &= \\frac{x-4}{6} + \\frac{x+1}{3} \\\\ &= \\frac{(x-4) + 2(x+1)}{6} \\\\ &= \\frac{x-4+2x+2}{6} \\\\ &= \\frac{3x-2}{6} \\end{aligned}" },
  // --- 【4番目が正解の問題】 (25問) ---
  { question: "$\\frac{x+4}{5} + \\frac{x-1}{2}$", choices: ["$\\frac{2x+3}{7}$", "$\\frac{7x+13}{10}$", "$\\frac{7x-3}{10}$", "$\\frac{7x+3}{10}$"], answer: "$\\frac{7x+3}{10}$", process: "\\begin{aligned} & \\frac{x+4}{5} + \\frac{x-1}{2} \\\\ &= \\frac{2(x+4) + 5(x-1)}{10} \\\\ &= \\frac{2x+8 + 5x-5}{10} \\\\ &= \\frac{7x+3}{10} \\end{aligned}" },
  { question: "$\\frac{5x-1}{4} - \\frac{x+2}{3}$", choices: ["$\\frac{4x-3}{1}$", "$\\frac{11x-5}{12}$", "$\\frac{11x+1}{12}$", "$\\frac{11x-11}{12}$"], answer: "$\\frac{11x-11}{12}$", process: "\\begin{aligned} & \\frac{5x-1}{4} - \\frac{x+2}{3} \\\\ &= \\frac{3(5x-1) - 4(x+2)}{12} \\\\ &= \\frac{15x-3 - 4x-8}{12} \\\\ &= \\frac{11x-11}{12} \\end{aligned}" },
  { question: "$4x + \\frac{x-2}{3}$", choices: ["$\\frac{5x-2}{3}$", "$\\frac{11x+2}{3}$", "$13x-2$", "$\\frac{13x-2}{3}$"], answer: "$\\frac{13x-2}{3}$", process: "\\begin{aligned} & 4x + \\frac{x-2}{3} \\\\ &= \\frac{12x}{3} + \\frac{x-2}{3} \\\\ &= \\frac{12x+x-2}{3} \\\\ &= \\frac{13x-2}{3} \\end{aligned}" },
  { question: "$\\frac{6x+1}{4} - \\frac{x-3}{2}$", choices: ["$\\frac{5x+4}{2}$", "$\\frac{4x-5}{4}$", "$\\frac{8x-5}{4}$", "$\\frac{4x+7}{4}$"], answer: "$\\frac{4x+7}{4}$", process: "\\begin{aligned} & \\frac{6x+1}{4} - \\frac{x-3}{2} \\\\ &= \\frac{(6x+1) - 2(x-3)}{4} \\\\ &= \\frac{6x+1 - 2x+6}{4} \\\\ &= \\frac{4x+7}{4} \\end{aligned}" },
  { question: "$\\frac{x}{5} + \\frac{4x+1}{10}$", choices: ["$\\frac{5x+1}{15}$", "$\\frac{2x+1}{10}$", "$\\frac{6x+1}{50}$", "$\\frac{6x+1}{10}$"], answer: "$\\frac{6x+1}{10}$", process: "\\begin{aligned} & \\frac{x}{5} + \\frac{4x+1}{10} \\\\ &= \\frac{2x}{10} + \\frac{4x+1}{10} \\\\ &= \\frac{2x+4x+1}{10} \\\\ &= \\frac{6x+1}{10} \\end{aligned}" },
  { question: "$2x - \\frac{3x+2}{4}$", choices: ["$\\frac{-x-2}{4}$", "$\\frac{11x-2}{4}$", "$5x-2$", "$\\frac{5x-2}{4}$"], answer: "$\\frac{5x-2}{4}$", process: "\\begin{aligned} & 2x - \\frac{3x+2}{4} \\\\ &= \\frac{8x}{4} - \\frac{3x+2}{4} \\\\ &= \\frac{8x - (3x+2)}{4} \\\\ &= \\frac{8x-3x-2}{4} \\\\ &= \\frac{5x-2}{4} \\end{aligned}" },
  { question: "$\\frac{-x+5}{2} + \\frac{3x-1}{4}$", choices: ["$\\frac{2x+4}{6}$", "$\\frac{x+11}{4}$", "$\\frac{5x+9}{4}$", "$\\frac{x+9}{4}$"], answer: "$\\frac{x+9}{4}$", process: "\\begin{aligned} & \\frac{-x+5}{2} + \\frac{3x-1}{4} \\\\ &= \\frac{2(-x+5) + (3x-1)}{4} \\\\ &= \\frac{-2x+10 + 3x-1}{4} \\\\ &= \\frac{x+9}{4} \\end{aligned}" },
  { question: "$\\frac{x-3}{2} - \\frac{5x+1}{4}$", choices: ["$\\frac{-4x-4}{2}$", "$\\frac{-3x-5}{4}$", "$\\frac{7x-7}{4}$", "$\\frac{-3x-7}{4}$"], answer: "$\\frac{-3x-7}{4}$", process: "\\begin{aligned} & \\frac{x-3}{2} - \\frac{5x+1}{4} \\\\ &= \\frac{2(x-3) - (5x+1)}{4} \\\\ &= \\frac{2x-6 - 5x-1}{4} \\\\ &= \\frac{-3x-7}{4} \\end{aligned}" },
  { question: "$\\frac{2x-4}{5} + 3x$", choices: ["$\\frac{5x-4}{5}$", "$\\frac{13x-4}{5}$", "$17x-4$", "$\\frac{17x-4}{5}$"], answer: "$\\frac{17x-4}{5}$", process: "\\begin{aligned} & \\frac{2x-4}{5} + 3x \\\\ &= \\frac{2x-4}{5} + \\frac{15x}{5} \\\\ &= \\frac{2x-4+15x}{5} \\\\ &= \\frac{17x-4}{5} \\end{aligned}" },
  { question: "$\\frac{x+9}{4} - x$", choices: ["$\\frac{9}{4}$", "$\\frac{-3x-9}{4}$", "$-3x+9$", "$\\frac{-3x+9}{4}$"], answer: "$\\frac{-3x+9}{4}$", process: "\\begin{aligned} & \\frac{x+9}{4} - x \\\\ &= \\frac{x+9}{4} - \\frac{4x}{4} \\\\ &= \\frac{x+9-4x}{4} \\\\ &= \\frac{-3x+9}{4} \\end{aligned}" },
  { question: "$\\frac{4(x-1)}{3} + \\frac{x+2}{6}$", choices: ["$\\frac{5x+1}{9}$", "$\\frac{9x-6}{6}$", "$\\frac{9x+6}{6}$", "$\\frac{9x-2}{6}$"], answer: "$\\frac{9x-2}{6}$", process: "\\begin{aligned} & \\frac{4(x-1)}{3} + \\frac{x+2}{6} \\\\ &= \\frac{4x-4}{3} + \\frac{x+2}{6} \\\\ &= \\frac{2(4x-4) + (x+2)}{6} \\\\ &= \\frac{8x-8+x+2}{6} \\\\ &= \\frac{9x-2}{6} \\end{aligned}" },
  { question: "$\\frac{5(x+1)}{3} - \\frac{3(x-1)}{2}$", choices: ["$\\frac{2x+2}{1}$", "$\\frac{x+1}{6}$", "$\\frac{19x+19}{6}$", "$\\frac{x+19}{6}$"], answer: "$\\frac{x+19}{6}$", process: "\\begin{aligned} & \\frac{5(x+1)}{3} - \\frac{3(x-1)}{2} \\\\ &= \\frac{5x+5}{3} - \\frac{3x-3}{2} \\\\ &= \\frac{2(5x+5) - 3(3x-3)}{6} \\\\ &= \\frac{10x+10 - 9x+9}{6} \\\\ &= \\frac{x+19}{6} \\end{aligned}" },
  { question: "$\\frac{x-7}{5} + \\frac{x+1}{10}$", choices: ["$\\frac{2x-6}{15}$", "$\\frac{3x-6}{10}$", "$\\frac{3x-15}{10}$", "$\\frac{3x-13}{10}$"], answer: "$\\frac{3x-13}{10}$", process: "\\begin{aligned} & \\frac{x-7}{5} + \\frac{x+1}{10} \\\\ &= \\frac{2(x-7) + (x+1)}{10} \\\\ &= \\frac{2x-14+x+1}{10} \\\\ &= \\frac{3x-13}{10} \\end{aligned}" },
  { question: "$\\frac{7x+1}{6} - \\frac{x-3}{2}$", choices: ["$\\frac{6x+4}{4}$", "$\\frac{4x+7}{6}$", "$\\frac{4x-8}{6}$", "$\\frac{4x+10}{6}$"], answer: "$\\frac{4x+10}{6}$", process: "\\begin{aligned} & \\frac{7x+1}{6} - \\frac{x-3}{2} \\\\ &= \\frac{(7x+1) - 3(x-3)}{6} \\\\ &= \\frac{7x+1 - 3x+9}{6} \\\\ &= \\frac{4x+10}{6} \\end{aligned}" },
  { question: "$\\frac{1}{3}(x+2) + \\frac{1}{2}(x-3)$", choices: ["$\\frac{2x-1}{5}$", "$\\frac{5x+1}{6}$", "$\\frac{5x-7}{6}$", "$\\frac{5x-5}{6}$"], answer: "$\\frac{5x-5}{6}$", process: "\\begin{aligned} & \\frac{1}{3}(x+2) + \\frac{1}{2}(x-3) \\\\ &= \\frac{x+2}{3} + \\frac{x-3}{2} \\\\ &= \\frac{2(x+2) + 3(x-3)}{6} \\\\ &= \\frac{2x+4 + 3x-9}{6} \\\\ &= \\frac{5x-5}{6} \\end{aligned}" },
  { question: "$\\frac{2}{5}(x-2) - \\frac{1}{2}(x+1)$", choices: ["$\\frac{x-3}{-3}$", "$\\frac{-x-9}{10}$", "$\\frac{-x-3}{10}$", "$\\frac{-x-13}{10}$"], answer: "$\\frac{-x-13}{10}$", process: "\\begin{aligned} & \\frac{2}{5}(x-2) - \\frac{1}{2}(x+1) \\\\ &= \\frac{2x-4}{5} - \\frac{x+1}{2} \\\\ &= \\frac{2(2x-4) - 5(x+1)}{10} \\\\ &= \\frac{4x-8 - 5x-5}{10} \\\\ &= \\frac{-x-13}{10} \\end{aligned}" },
  { question: "$6x + \\frac{3-2x}{3}$", choices: ["$\\frac{4x+3}{3}$", "$\\frac{20x+3}{3}$", "$16x+3$", "$\\frac{16x+3}{3}$"], answer: "$\\frac{16x+3}{3}$", process: "\\begin{aligned} & 6x + \\frac{3-2x}{3} \\\\ &= \\frac{18x}{3} + \\frac{3-2x}{3} \\\\ &= \\frac{18x+3-2x}{3} \\\\ &= \\frac{16x+3}{3} \\end{aligned}" },
  { question: "$\\frac{8x+3}{6} - x$", choices: ["$\\frac{7x+3}{6}$", "$\\frac{9x+3}{6}$", "$2x+3$", "$\\frac{2x+3}{6}$"], answer: "$\\frac{2x+3}{6}$", process: "\\begin{aligned} & \\frac{8x+3}{6} - x \\\\ &= \\frac{8x+3}{6} - \\frac{6x}{6} \\\\ &= \\frac{8x+3-6x}{6} \\\\ &= \\frac{2x+3}{6} \\end{aligned}" },
  { question: "$\\frac{x-1}{8} + \\frac{x+3}{4}$", choices: ["$\\frac{2x+2}{12}$", "$\\frac{3x+7}{8}$", "$\\frac{3x-5}{8}$", "$\\frac{3x+5}{8}$"], answer: "$\\frac{3x+5}{8}$", process: "\\begin{aligned} & \\frac{x-1}{8} + \\frac{x+3}{4} \\\\ &= \\frac{(x-1) + 2(x+3)}{8} \\\\ &= \\frac{x-1+2x+6}{8} \\\\ &= \\frac{3x+5}{8} \\end{aligned}" },
  { question: "$\\frac{7x-2}{10} - \\frac{x+1}{5}$", choices: ["$\\frac{6x-3}{5}$", "$\\frac{5x}{10}$", "$\\frac{9x-4}{10}$", "$\\frac{5x-4}{10}$"], answer: "$\\frac{5x-4}{10}$", process: "\\begin{aligned} & \\frac{7x-2}{10} - \\frac{x+1}{5} \\\\ &= \\frac{(7x-2) - 2(x+1)}{10} \\\\ &= \\frac{7x-2 - 2x-2}{10} \\\\ &= \\frac{5x-4}{10} \\end{aligned}" },
  { question: "$\\frac{1}{5}(x+3) + \\frac{1}{10}(x-1)$", choices: ["$\\frac{2x+2}{15}$", "$\\frac{3x+7}{10}$", "$\\frac{3x-7}{10}$", "$\\frac{3x+5}{10}$"], answer: "$\\frac{3x+5}{10}$", process: "\\begin{aligned} & \\frac{1}{5}(x+3) + \\frac{1}{10}(x-1) \\\\ &= \\frac{x+3}{5} + \\frac{x-1}{10} \\\\ &= \\frac{2(x+3) + (x-1)}{10} \\\\ &= \\frac{2x+6+x-1}{10} \\\\ &= \\frac{3x+5}{10} \\end{aligned}" },
  { question: "$\\frac{4}{3}(x-1) - \\frac{1}{6}(x+1)$", choices: ["$\\frac{3x-2}{ -3}$", "$\\frac{7x-7}{6}$", "$\\frac{9x-9}{6}$", "$\\frac{7x-9}{6}$"], answer: "$\\frac{7x-9}{6}$", process: "\\begin{aligned} & \\frac{4}{3}(x-1) - \\frac{1}{6}(x+1) \\\\ &= \\frac{4x-4}{3} - \\frac{x+1}{6} \\\\ &= \\frac{2(4x-4) - (x+1)}{6} \\\\ &= \\frac{8x-8 - x-1}{6} \\\\ &= \\frac{7x-9}{6} \\end{aligned}" },
  { question: "$\\frac{x+7}{5} + \\frac{x-1}{10}$", choices: ["$\\frac{2x+6}{15}$", "$\\frac{3x+6}{10}$", "$\\frac{3x+15}{10}$", "$\\frac{3x+13}{10}$"], answer: "$\\frac{3x+13}{10}$", process: "\\begin{aligned} & \\frac{x+7}{5} + \\frac{x-1}{10} \\\\ &= \\frac{2(x+7) + (x-1)}{10} \\\\ &= \\frac{2x+14+x-1}{10} \\\\ &= \\frac{3x+13}{10} \\end{aligned}" },
  { question: "$\\frac{8x+1}{6} - \\frac{x-1}{2}$", choices: ["$\\frac{7x+2}{4}$", "$\\frac{5x-2}{6}$", "$\\frac{11x+4}{6}$", "$\\frac{5x+4}{6}$"], answer: "$\\frac{5x+4}{6}$", process: "\\begin{aligned} & \\frac{8x+1}{6} - \\frac{x-1}{2} \\\\ &= \\frac{(8x+1) - 3(x-1)}{6} \\\\ &= \\frac{8x+1 - 3x+3}{6} \\\\ &= \\frac{5x+4}{6} \\end{aligned}" },
  { question: "$-4x + \\frac{x+5}{2}$", choices: ["$\\frac{-3x+5}{2}$", "$\\frac{-9x+5}{2}$", "$-7x+5$", "$\\frac{-7x+5}{2}$"], answer: "$\\frac{-7x+5}{2}$", process: "\\begin{aligned} & -4x + \\frac{x+5}{2} \\\\ &= \\frac{-8x}{2} + \\frac{x+5}{2} \\\\ &= \\frac{-8x+x+5}{2} \\\\ &= \\frac{-7x+5}{2} \\end{aligned}" }
];
        // ===== グローバル変数定義 =====
        const modeSelectionScreen = document.getElementById('mode-selection');
        const quizMainScreen = document.getElementById('quiz-main');
        const musouBackground = document.getElementById('musou-background');

        const questionArea = document.getElementById('question-area');
        const nextButton = document.getElementById('next-btn');
        const resultsArea = document.getElementById('results');
        const scoreDisplay = document.getElementById('score');
        const timerBar = document.getElementById('timer-bar');
        const timerText = document.getElementById('timer-text');
        
        let selectedQuizData;
        let currentQuestionIndex = 0;
        let score = 0;
        
        let timerInterval;
        let timeLeft;
        let TIME_LIMIT;
        let WARNING_TIME;
        
        let totalSolveTime = 0;
        let questionStartTime;

        // ===== モード選択とクイズ開始の処理 =====
        document.getElementById('normal-mode-btn').addEventListener('click', () => {
            startGame({
                timeLimit: 15,
                warningTime: 5,
                isMusou: false
            });
        });

        document.getElementById('musou-mode-btn').addEventListener('click', () => {
            startGame({
                timeLimit: 5,
                warningTime: 3,
                isMusou: true
            });
        });

        function startGame(settings) {
            TIME_LIMIT = settings.timeLimit;
            WARNING_TIME = settings.warningTime;

            if (settings.isMusou) {
                musouBackground.classList.remove('hidden');
            }

            // 問題をシャッフルして10問選ぶ
            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            const shuffledData = shuffleArray(fullQuizDataBank);
            selectedQuizData = shuffledData.slice(0, 10);

            // 画面切り替え
            modeSelectionScreen.classList.add('hidden');
            quizMainScreen.classList.remove('hidden');

            // クイズ開始
            showQuestion();
        }


        // ===== タイマー関数 =====
        function startTimer() {
            timeLeft = TIME_LIMIT;
            timerText.textContent = timeLeft;
            timerBar.style.width = '100%';
            timerBar.classList.remove('warning');
            document.body.classList.remove('timer-warning');

            timerInterval = setInterval(() => {
                timeLeft--;
                timerText.textContent = timeLeft;
                timerBar.style.width = (timeLeft / TIME_LIMIT) * 100 + '%';

                if (timeLeft <= WARNING_TIME) {
                    timerBar.classList.add('warning');
                    document.body.classList.add('timer-warning');
                }

                if (timeLeft <= 0) {
                    timeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

       function timeUp() {
            stopTimer();
            totalSolveTime += TIME_LIMIT;

            const choicesContainer = questionArea.querySelector('.choices');
            const feedbackMessage = document.getElementById('feedback-message');
            const processDisplay = document.getElementById('calculation-process');
            const currentQuestion = selectedQuizData[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer.replace(/\$/g, ''); // ★ $ 除去

            if(choicesContainer) {
                choicesContainer.classList.add('answered');
            }

            feedbackMessage.textContent = "時間切れ💦";
            feedbackMessage.classList.add('incorrect-feedback');
            feedbackMessage.classList.remove('hidden');

            katex.render(currentQuestion.process, processDisplay, { throwOnError: false, displayMode: true });
            processDisplay.classList.remove('hidden');

            Array.from(choicesContainer.children).forEach(child => {
                // ★★★ child.textContent から $ を除去して比較 ★★★
                const choiceText = child.textContent.replace(/\$/g, ''); 
                if (choiceText === correctAnswer) {
                     child.classList.add('correct');
                }
            });

            if (currentQuestionIndex < selectedQuizData.length - 1) {
                nextButton.innerText = "次の問題へ";
            } else {
                nextButton.innerText = "結果を見る";
            }
            nextButton.classList.remove('hidden');
        }

// ===== クイズ本体の関数 =====
        function showQuestion() {
            const currentQuestion = selectedQuizData[currentQuestionIndex];
            
            const choicesHtml = currentQuestion.choices.map(choice => {
                const onclickChoice = choice.replace(/\$/g, ''); 
                return `<div class="choice" onclick="selectAnswer(this, '${onclickChoice}')">${choice}</div>`;
            }).join('');

            questionArea.innerHTML = `
                <div class="question-block">
                    <div class="problem-text" id="problem-text"></div>
                    <div class="choices">${choicesHtml}</div>
                    <div class="feedback-area">
                        <p id="feedback-message" class="hidden"></p>
                        <div id="calculation-process" class="calculation-process hidden"></div>
                    </div>
                </div>
            `;
            
            // ★★★ 問題文のテキストから $ を除去してKaTeXでレンダリング ★★★
            const problemTextElement = document.getElementById('problem-text');
            // question 文字列から $ を除去 (例: "$2(x+y)+...$" -> "2(x+y)+...")
            const questionKatexString = currentQuestion.question.slice(1, -1); 
            try {
                // $ を除去した文字列をレンダリング
                katex.render(questionKatexString, problemTextElement, { 
                    throwOnError: true, // エラーを強制的に表示
                    displayMode: true // 問題文は独立した行で表示
                });
            } catch (e) {
                 console.error("KaTeX render error on question:", currentQuestion.question, e);
                 // エラー時は元のテキスト（$付き）を表示
                 problemTextElement.textContent = currentQuestion.question;
            }


            // 各選択肢のテキストから $ を除去してKaTeXでレンダリング
            const choiceElements = questionArea.querySelectorAll('.choice');
            choiceElements.forEach(element => {
                const katexString = element.textContent.slice(1, -1); 
                try {
                    katex.render(katexString, element, { 
                        throwOnError: true, 
                        displayMode: false 
                    }); 
                } catch (e) {
                    console.error("KaTeX render error on choice:", element.textContent, e); 
                    element.innerHTML = element.textContent; 
                }
            });
            
            questionStartTime = Date.now();
            startTimer();
        }        
        function selectAnswer(element, selectedChoice) {
            stopTimer();
            const timeTaken = (Date.now() - questionStartTime) / 1000;
            totalSolveTime += timeTaken;

            const choicesContainer = element.parentElement;
            if (choicesContainer.classList.contains('answered')) return;
            choicesContainer.classList.add('answered');

            const currentQuestion = selectedQuizData[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer.replace(/\$/g, ''); 

            const feedbackMessage = document.getElementById('feedback-message');
            const processDisplay = document.getElementById('calculation-process');

            if (selectedChoice === correctAnswer) { 
                score++;
                element.classList.add('correct');
                feedbackMessage.textContent = "正解💐";
                feedbackMessage.classList.add('correct-feedback');
            } else {
                element.classList.add('incorrect');
                feedbackMessage.textContent = "不正解💦";
                feedbackMessage.classList.add('incorrect-feedback');
                
                katex.render(currentQuestion.process, processDisplay, { throwOnError: false, displayMode: true });
                processDisplay.classList.remove('hidden');

                 // 正解の選択肢をハイライト
                Array.from(choicesContainer.children).forEach(child => {
                    // ★★★ child.textContent から $ を除去して比較 ★★★
                    const choiceText = child.textContent.replace(/\$/g, ''); 
                    if (choiceText === correctAnswer) {
                         child.classList.add('correct');
                    }
                });
            }
            
            feedbackMessage.classList.remove('hidden');
            
            if (currentQuestionIndex < selectedQuizData.length - 1) {
                nextButton.innerText = "次の問題へ";
            } else {
                nextButton.innerText = "結果を見る";
            }
            nextButton.classList.remove('hidden');
        }

        nextButton.addEventListener('click', () => {
            currentQuestionIndex++;
            document.body.classList.remove('timer-warning');
            if (currentQuestionIndex < selectedQuizData.length) {
                showQuestion();
                nextButton.classList.add('hidden');
            } else {
                showResults();
            }
        });

        function showResults() {
            questionArea.classList.add('hidden');
            nextButton.classList.add('hidden');
            document.querySelector('.timer-container').classList.add('hidden');
            
            const finalScore = score * 10;
            const totalPoints = selectedQuizData.length * 10;
            const totalSeconds = Math.round(totalSolveTime);

            let rank = '';
            let rankColor = '';

            if (totalSeconds <= 30) {
                rank = '⭐️ Sランク ⭐️'; rankColor = '#ffc107';
            } else if (totalSeconds <= 45) {
                rank = '🌛 Aランク 🌛'; rankColor = '#6c757d';
            } else if (totalSeconds <= 60) {
                rank = '🌲 Bランク 🌲'; rankColor = '#cd7f32';
            } else {
                rank = '💪 Cランク 💪'; rankColor = '#28a745';
            }

            resultsArea.classList.remove('hidden');
            
            const timeInfoDisplay = document.getElementById('time-info');
            const rankInfoDisplay = document.getElementById('rank-info');

            scoreDisplay.textContent = `${finalScore}点 / ${totalPoints}点満点`;
            timeInfoDisplay.textContent = `合計解答時間: ${totalSeconds}秒`;
            rankInfoDisplay.textContent = rank;
            rankInfoDisplay.style.color = rankColor;
        }
    </script>

</body>
</html>
